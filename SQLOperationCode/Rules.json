

{"SQLID":300000053,"OperationSQL":"/* Operation Name :  Build master table \n Add Rule Description here.*/\n /* Operation Name :  Load to Import \n Add Rule Description here.*/\n\n/*Docstart\n2024-06-04 Paul Bigg\nBuild of the staging for main CDS data table (INP_CDS_63_INPATIENT_MAIN) for all in-flight data after successfull BEDROCK data run.\nIn-flight data could be a full data run or a delta run of altered data.  \nOne record is a single FINISHED CONSULTANT EPISODE\nRestiricted to records from INP_CONSULTANT_EPISODE_HOSPITAL_PROVIDER_SPELL where Active_Flag =1\n\nSOURCE TABLES:\n\tINP_CONSULTANT_EPISODE_HOSPITAL_PROVIDER_SPELL (Finished episode details)\n\tINP_HOSPITAL_PROVIDER_SPELL (Hospital Spell details)\n\tPATIENT (Demographic Details)  - Equi join as patient record is required\n\tPATIENT_ADDRESS (Address at activity date)\r\n\tINP_CONSULTANT_EPISODE_HOSPITAL_PROVIDER_SPELL_DIAGNOSIS_SR WHERE DIAGNOSIS_SCHEME_IN_USE = 'ICD10' (episodic diagnoses)\r\n\tINP_CONSULTANT_EPISODE_HOSPITAL_PROVIDER_SPELL_PROCEDURE_SR WHERE PROCEDURE_SCHEME_IN_USE = 'OPCS4' (episodic procedures)\r\n\tINP_CONSULTANT_EPISODE_HOSPITAL_PROVIDER_SPELL_WARD_STAY WHERE FIRST_WARD_FLAG = 1 (First ward in spell)\r\n\tINP_CONSULTANT_EPISODE_HOSPITAL_PROVIDER_SPELL_WARD_STAY WHERE LAST_WARD_FLAG = 1 (Last ward in spell)\r\n\tPATHWAY (Patient Pathway information)\n\nAMENDMENTS:\n\tv1-Script created\n\nDocend*/\n\n /*\r\nSelect * Into [INP_CDS_63_INPATIENT_MAIN] From [INP_CDS_INPATIENT_GENERAL] Where 1=2\r\nAlter Table INP_CDS_63_INPATIENT_MAIN Add EXTRACT_RECORD_ID Bigint, SUBMITTED_FLAG Bit, HASHVAL Varchar(100)\r\nSelect * Into [CDS_63_INPATIENT_MAIN] From [INP_CDS_63_INPATIENT_MAIN] Where 1=2\r\nSelect * Into [ARC_CDS_63_INPATIENT_MAIN] From [INP_CDS_63_INPATIENT_MAIN] Where 1=2\r\nSelect * Into [TMP_CDS_63_INPATIENT_MAIN] From [INP_CDS_63_INPATIENT_MAIN] Where 1=2\r\n\r\nAlter Table TMP_ECDS_30_MAIN Add EXTRACT_RECORD_ID Bigint, SUBMITTED_FLAG Bit, HASHVAL Varchar(100)\r\nAlter Table ECDS_30_MAIN Add EXTRACT_RECORD_ID Bigint, SUBMITTED_FLAG Bit, HASHVAL Varchar(100)\r\nAlter Table ARC_ECDS_30_MAIN Add EXTRACT_RECORD_ID Bigint, SUBMITTED_FLAG Bit, HASHVAL Varchar(100)\r\nAlter Table INP_ECDS_30_MAIN Add EXTRACT_RECORD_ID Bigint, SUBMITTED_FLAG Bit, HASHVAL Varchar(100)\r\n*/\n\ndelete INP_CDS_63_INPATIENT_MAIN\n\n set dateformat  dmy\n\t\n\tDeclare @CDS_INTERCHANGE_SENDER_IDENTITY varchar(50)\r\n\tDeclare @CDS_SENDER_IDENTITY varchar(10)\r\n\tDeclare @CDS_ORGANISATIONN_SITE_DEFAULT varchar(10)\r\n\tDeclare @ORGANISATION_CODE_CODE_OF_PROVIDER_DEFAULT varchar(10)\r\n\tDeclare @ORGANISATION_IDENTIFIER varchar(10)\r\n\tDeclare @ORGANISATION_CODE_CODE_OF_COMMISSIONER_DEFAULT varchar(10)\r\n\t\r\n\tset @CDS_INTERCHANGE_SENDER_IDENTITY = [dbo].[udf_GetParameter]('CDS_INTERCHANGE_SENDER_IDENTITY')\r\n\tset @CDS_SENDER_IDENTITY = [dbo].[udf_GetParameter]('CDS_SENDER_IDENTITY')\r\n\tset @CDS_ORGANISATIONN_SITE_DEFAULT =  [dbo].[udf_GetParameter]('CDS_DEFAULT_ORGANISATION_SITE')\r\n\tset @ORGANISATION_CODE_CODE_OF_PROVIDER_DEFAULT = ISNULL([dbo].[udf_GetParameter]('ORGANISATION_CODE_CODE_OF_PROVIDER'),[dbo].[udf_GetParameter]('ORGANISATION_CODE_OF_PROVIDER'))\r\n\tset @ORGANISATION_IDENTIFIER = [dbo].[udf_GetParameter]('CDS_SENDER_IDENTITY')\n\tset @ORGANISATION_CODE_CODE_OF_COMMISSIONER_DEFAULT = [dbo].[udf_GetParameter]('ORGANISATION_CODE_DEFAULT_COMMISSIONER_CDS')\n\n\n\nINSERT INTO [dbo].[INP_CDS_63_INPATIENT_MAIN]\r\n           ([RECORD_ID]\r\n           ,[CONSULTANT_EPISODE_HOSPITAL_PROVIDER_SPELL_RECORD_ID]\r\n           ,[PATIENT_RECORD_ID]\r\n           ,[CONSULTANT_EPISODE_HOSPITAL_PROVIDER_SPELL_SOURCE_ID]\r\n           ,[LINE_ID_01]\r\n           ,[CDS_VERSION]\r\n           ,[CDS_TYPE]\r\n           ,[CDS_PROTOCOL_ID]\r\n           ,[CDS_UNIQUE_ID]\r\n           ,[CDS_BULK_REPLACEMENT_GROUP]\r\n           ,[CDS_UPDATE_TYPE]\r\n           ,[CDS_EXTRACT_DATE]\r\n           ,[CDS_EXTRACT_TIME]\r\n           ,[CDS_APPLICABLE_DATE]\r\n           ,[CDS_APPLICABLE_TIME]\r\n           ,[CDS_REPORT_PERIOD_START_DATE]\r\n           ,[CDS_REPORT_PERIOD_END_DATE]\r\n           ,[CDS_ACTIVITY_DATE]\r\n           ,[CDS_TEST_INDICATOR]\r\n           ,[ORGANISATION_IDENTIFIER_CDS_SENDER]\r\n           ,[ORGANISATION_IDENTIFIER_CDS_RECIPIENT]\r\n           ,[RECORD_CONNECTION_IDENTIFIER_01]\r\n           ,[NAME_FORMAT_CODE]\r\n           ,[CDS_PRIMARY_RECIPIENT]\r\n           ,[CDS_COPY_RECIPIENT_01]\r\n           ,[CDS_COPY_RECIPIENT_02]\r\n           ,[CDS_COPY_RECIPIENT_03]\r\n           ,[CDS_COPY_RECIPIENT_04]\r\n           ,[CDS_COPY_RECIPIENT_05]\r\n           ,[Unique_Booking_ReferenceNumber_Converted]\r\n           ,[Patient_Pathway_Identifier]\r\n           ,[Organisation_Identifier_Patient_Pathway_Identifier_Issuer]\r\n           ,[REFERRAL_TO_TREATMENT_PERIOD_STATUS]\r\n           ,[WAITING_TIME_MEASUREMENT_TYPE_COMMISSIONING_DATASET]\r\n           ,[REFERRAL_TO_TREATMENT_PERIOD_START_DATE]\r\n           ,[REFERRAL_TO_TREATMENT_PERIOD_END_DATE]\r\n           ,[LOCAL_PATIENT_IDENTIFIER_EXTENDED]\r\n           ,[ORGANISATION_IDENTIFIER_LOCAL_PATIENT_IDENTIFIER]\r\n           ,[NHS_NUMBER]\r\n           ,[NHS_NUMBER_STATUS_INDICATOR_CODE]\r\n           ,[PERSON_GIVEN_NAME]\r\n           ,[PERSON_TITLE]\r\n           ,[PERSON_FULL_NAME]\r\n           ,[PERSON_FAMILY_NAME]\r\n           ,[PATIENT_NAME_SUFFIX]\r\n           ,[PATIENT_INITIALS]\r\n           ,[UNSTRUCTURED_ADDRESS]\r\n           ,[ADDRESS_LINE_1]\r\n           ,[ADDRESS_LINE_2]\r\n           ,[ADDRESS_LINE_3]\r\n           ,[ADDRESS_LINE_4]\r\n           ,[ADDRESS_LINE_5]\r\n           ,[POSTCODE_OF_USUAL_ADDRESS]\r\n           ,[ORGANISATION_IDENTIFIER_RESIDENCE_RESPONSIBILITY]\r\n           ,[PERSON_BIRTH_DATE]\r\n           ,[MODIFIED_DATE_TIME]\r\n           ,[ADDED_DATE_TIME]\r\n           ,[WITHHELD_FLAG]\r\n           ,[WITHHELD_IDENTITY_REASON]\r\n           ,[ADDRESS_FORMAT_CODE]\r\n           ,[PERSON_STATED_GENDER_CODE]\r\n           ,[CARER_SUPPORT_INDICATOR]\r\n           ,[ETHNIC_CATEGORY]\r\n           ,[ETHNIC_CATEGORY_2021]\r\n           ,[PERSON_MARITAL_STATUS]\r\n           ,[MENTAL_HEALTH_ACT_LEGAL_STATUS_CLASSIFICATION_CODE_ON_ADMISSION]\r\n           ,[SOCIAL_AND_PERSONAL_CIRCUMSTANCE_SNOMED_CT]\r\n           ,[HOSPITAL_PROVIDER_SPELL_IDENTIFIER]\r\n           ,[ADMINISTRATIVE_CATEGORY_CODE_ON_ADMISSION]\r\n           ,[PATIENT_CLASSIFICATION]\r\n           ,[METHOD_OF_ADMISSION_HOSPITAL_PROVIDER_SPELL]\r\n           ,[ADMISSION_SOURCE_HOSPITAL_PROVIDER_SPELL]\r\n           ,[START_DATE_HOSPITAL_PROVIDER_SPELL]\r\n           ,[START_TIME_HOSPITAL_PROVIDER_SPELL]\r\n           ,[AGE_ON_ADMISSION]\r\n           ,[AMBULANCE_CALL_IDENTIFIER]\r\n           ,[ORGANISATION_IDENTIFIER_CONVEYING_AMBULANCE_TRUST]\r\n           ,[CARE_CONTACT_IDENTIFIER_AMBULANCE_SERVICE]\r\n           ,[DESTINATION_OF_DISCHARGE_HOSPITAL_PROVIDER_SPELL]\r\n           ,[METHOD_OF_DISCHARGE_HOSPITAL_PROVIDER_SPELL]\r\n           ,[DISCHARGE_READY_DATE_TIME]\r\n           ,[DISCHARGE_DATE_HOSPITAL_PROVIDER_SPELL]\r\n           ,[DISCHARGE_TIME_HOSPITAL_PROVIDER_SPELL]\r\n           ,[DISCHARGE_TO_NHS_AT_HOME_SERVICE_INDICATOR]\r\n           ,[EPISODE_NUMBER]\r\n           ,[LAST_EPISODE_IN_SPELL_INDICATOR_CODE]\r\n           ,[ADMINISTRATIVE_CATEGORY]\r\n           ,[NEONATAL_LEVEL_OF_CARE_CODE]\r\n           ,[FIRST_REGULAR_DAY_OR_NIGHT_ADMISSION_CODE]\r\n           ,[PSYCHIATRIC_PATIENT_STATUS_CODE]\r\n           ,[START_DATE_EPISODE]\r\n           ,[START_TIME_EPISODE]\r\n           ,[END_DATE_EPISODE]\r\n           ,[END_TIME_EPISODE]\r\n           ,[AGE_AT_CDS_ACTIVITY_DATE]\r\n           ,[REHABILITATION_ASSESSMENT_TEAM_TYPE]\r\n           ,[LENGTH_OF_STAY_ADJUSTMENT_REHABILITATION]\r\n           ,[LENGTH_OF_STAY_ADJUSTMENT_SPECIALIST_PALLIATIVE_CARE]\r\n           ,[OVERSEAS_VISITOR_CHARGING_CATEGORY]\r\n           ,[OVERSEAS_VISITOR_CHARGING_CATEGORY_APPLICABLE_FROM_DATE]\r\n           ,[OVERSEAS_VISITOR_CHARGING_CATEGORY_APPLICABLE_END_DATE]\r\n           ,[ORGANISATION_IDENTIFIER_CODE_OF_PROVIDER]\r\n           ,[ORGANISATION_IDENTIFIER_CODE_OF_COMMISSIONER]\r\n           ,[START_DATE_COMMISSIONER_ASSIGNMENT_PERIOD]\r\n           ,[END_DATE_COMMISSIONER_ASSIGNMENT_PERIOD]\r\n           ,[NHS_SERVICE_AGREEMENT_IDENTIFIER]\r\n           ,[NHS_SERVICE_AGREEMENT_LINE_IDENTIFIER]\r\n           ,[PROVIDER_REFERENCE_IDENTIFIER]\r\n           ,[COMMISSIONER_REFERENCE_IDENTIFIER]\r\n           ,[SERVICE_CODE]\r\n           ,[RESPONSIBLE_CARE_PROFESSIONAL_CT]\r\n           ,[DIAGNOSIS_SCHEME_IN_USE_COMMISSIONING_DATASET]\r\n           ,[PRIMARY_DIAGNOSIS_ICD]\r\n           ,[PRESENT_ON_ADMISSION_INDICATOR]\r\n           ,[SECONDARY_DIAGNOSIS_CT]\r\n           ,[CARE_EPISODE_CLINICAL_DIAGNOSIS_GROUP_SNOMED_CT]\r\n           ,[CARE_EPISODE_COMORBIDITY_GROUP_SNOMED_CT]\r\n           ,[EMED3_FIT_NOTE_ASSESSMENT_DATE]\r\n           ,[EMED3_FIT_NOTE_CONDITION_SNOMED_CT_EXPRESSION]\r\n           ,[EMED3_FIT_NOTE_DIAGNOSIS_ICD]\r\n           ,[EMED3_FIT_NOTE_START_DATE]\r\n           ,[EMED3_FIT_NOTE_END_DATE]\r\n           ,[EMED3_FIT_NOTE_DURATION]\r\n           ,[EMED3_FIT_NOTE_RECORDED_DATE]\r\n           ,[EMED3_FIT_NOTE_FOLLOW_UP_ASSESSMENT_REQUIRED_INDICATOR]\r\n           ,[EMED3_FIT_NOTE_ISSUER]\r\n           ,[PROCEDURE_SCHEME_IN_USE_COMMISSIONING_DATA_SET]\r\n           ,[PRIMARY_PROCEDURE]\r\n           ,[PROCEDURE_DATE]\r\n           ,[PROFESSIONAL_REGISTRATION_ISSUER_CODE]\r\n           ,[PROFESSIONAL_REGISTRATION_ENTRY_IDENTIFIER_MAIN_OPERATING_CARE_PROFESSIONAL]\r\n           ,[PROFESSIONAL_REGISTRATION_ISSUER_CODE_ANAESTHETIST]\r\n           ,[PROFESSIONAL_REGISTRATION_ENTRY_IDENTIFIER_RESPONSIBLE_ANAESTHETIST]\r\n           ,[SECONDARY_PROCEDURES_CT]\r\n           ,[CARE_EPISODE_PROCEDURE_GROUP_SNOMED_CT]\r\n           ,[CARE_EPISODE_OBSERVATION_GROUP_SNOMED_CT]\r\n           ,[CARE_EPISODE_FINDING_GROUP_SNOMED_CT]\r\n           ,[CARE_EPISODE_ASSESSMENT_TOOL_GROUP_SNOMED_CT]\r\n           ,[ORGANISATION_SITE_IDENTIFIER_OF_TREATMENT]\r\n           ,[ACTIVITY_LOCATION_TYPE_CODE]\r\n           ,[WARD_INTENDED_CLINICAL_CARE_INTENSITY]\r\n           ,[WARD_INTENDED_AGE_GROUP]\r\n           ,[WARD_INTENDED_SEX_OF_PATIENTS]\r\n           ,[WARD_INTENDED_DAY_PERIOD_AVAILABILITY]\r\n           ,[WARD_INTENDED_NIGHT_PERIOD_AVAILABILITY]\r\n           ,[WARD_SECURITY_LEVEL]\r\n           ,[WARD_CODE]\r\n           ,[LOCATION_GROUP_AT_WARD_STAY_CT]\r\n           ,[ORGANISATION_SITE_IDENTIFIER_OF_TREATMENT_LAST_EPI]\r\n           ,[ACTIVITY_LOCATION_TYPE_CODE_LAST_EPI]\r\n           ,[WARD_INTENDED_CLINICAL_CARE_INTENSITY_LAST_EPI]\r\n           ,[WARD_INTENDED_AGE_GROUP_LAST_EPI]\r\n           ,[WARD_INTENDED_SEX_OF_PATIENTS_LAST_EPI]\r\n           ,[WARD_INTENDED_DAY_PERIOD_AVAILABILITY_LAST_EPI]\r\n           ,[WARD_INTENDED_NIGHT_PERIOD_AVAILABILITY_LAST_EPI]\r\n           ,[WARD_SECURITY_LEVEL_LAST_EPI]\r\n           ,[WARD_CODE_LAST_EPI]\r\n           ,[LOCATION_GROUP_HOME_LEAVE]\r\n           ,[CARE_EPISODE_NEONATAL_CRITICAL_CARE_PERIOD_CT]\r\n           ,[CARE_EPISODE_PAEDIATRIC_CRITICAL_CARE_PERIOD_CT]\r\n           ,[ADULT_CRITICAL_CARE_ACTIVITY_CHARACTERISTICS]\r\n           ,[GENERAL_MEDICAL_PRACTITIONER_SPECIFIED]\r\n           ,[GENERAL_MEDICAL_PRACTICE_PATIENT_REGISTRATION]\r\n           ,[REFERRER_CODE]\r\n           ,[ORGANISATION_IDENTIFIER_REFERRING_ORGANISATION]\r\n           ,[DIRECT_ACCESS_REFERRAL_INDICATOR]\r\n           ,[DURATION_OF_ELECTIVE_WAIT]\r\n           ,[INTENDED_MANAGEMENT_CODE]\r\n           ,[DECIDED_TO_ADMIT_DATE]\r\n           ,[EARLIEST_REASONABLE_OFFER_DATE_TIME]\r\n           ,[EARLIEST_CLINICALLY_APPROPRIATE_DATE]\r\n           ,[LATEST_CLINICALLY_APPROPRIATE_DATE])\r\n\r\nSELECT DISTINCT\na.RECORD_ID ,\n\ta.RECORD_ID as CONSULTANT_EPISODE_HOSPITAL_PROVIDER_SPELL_RECORD_ID\n\t,p.RECORD_ID as PATIENT_RECORD_ID\n\t,a.SOURCE_ID CONSULTANT_EPISODE_HOSPITAL_PROVIDER_SPELL_SOURCE_ID\n\t--,a.HOSPITAL_PROVIDER_SPELL_NUMBER\n\n--Header details\n\n--TRANS AND BULK required?\n      ,'01' as LINE_ID_01\n      ,'NHS6-3' as CDS_VERSION\n      --,ISNULL(cast('130' AS VARCHAR(50)), '')\n\t  ,'130' as CDS_TYPE\n      ,ISNULL(cast('@P' AS VARCHAR(50)), '') CDS_PROTOCOL_ID\n      ,ISNULL(cast('B' + isnull(LEFT(h.ORGANISATION_CODE_OF_PROVIDER,3), '')+'00' + isnull(a.CDS_BATCH_CONTENT_ID, '') AS VARCHAR(50)), '') as CDS_UNIQUE_ID\n\t  --,ISNULL(cast('B' + isnull(h.ORGANISATION_CODE_OF_PROVIDER, '')+ isnull(a.CDS_BATCH_CONTENT_ID, '') AS VARCHAR(50)), '') as CDS_UNIQUE_ID\n      ,ISNULL(cast('010' AS VARCHAR(50)), '') as CDS_BULK_REPLACEMENT_GROUP\n      ,ISNULL(cast('@UT' AS VARCHAR(50)), '') as CDS_UPDATE_TYPE\n      , CONVERT(VARCHAR(10), GETDATE(),20) CDS_EXTRACT_DATE\n      ,CONVERT(VARCHAR(10), GETDATE(),24) as CDS_EXTRACT_TIME\n      ,ISNULL(CONVERT(VARCHAR(10), a.EPISODE_END_DATE_TIME,20), '') CDS_APPLICABLE_DATE\n      ,CONVERT(VARCHAR(10), EPISODE_END_DATE_TIME,24) CDS_APPLICABLE_TIME\n      ,ISNULL(cast('@PS' AS VARCHAR(50)), '') CDS_REPORT_PERIOD_START_DATE\n      ,ISNULL(cast('@PE' AS VARCHAR(50)), '') CDS_REPORT_PERIOD_END_DATE\n      ,ISNULL(CONVERT(VARCHAR(10), EPISODE_END_DATE_TIME,20), '') CDS_ACTIVITY_DATE\n      ,ISNULL(cast('' AS VARCHAR(50)), '') CDS_TEST_INDICATOR\n \n      ,@CDS_SENDER_IDENTITY as ORGANISATION_IDENTIFIER_CDS_SENDER  -- CDS_SENDER_IDENTITY\n\t  ,CAST(NULL as varchar(100)) AS ORGANISATION_IDENTIFIER_CDS_RECIPIENT --NEW\n      ,a.RECORD_ID as RECORD_CONNECTION_IDENTIFIER_01\n\n\t  --Updated to 01 by Ammy 25/7/2015\n\t  ,'01' NAME_FORMAT_CODE \n\t,a.CDS_PRIMARY_RECIPIENT\n\t,a.CDS_COPY_RECIPIENT_01\n\t,a.CDS_COPY_RECIPIENT_02\n\t,a.CDS_COPY_RECIPIENT_03\n\t,a.CDS_COPY_RECIPIENT_04\n\t,a.CDS_COPY_RECIPIENT_05\n\r\n\r\n--PATHWAY\n     , CAST('' AS VARCHAR(50)) Unique_Booking_ReferenceNumber_Converted\n      ,CAST(ISNULL(right(path.PATIENT_PATHWAY_IDENTIFIER,12),'') AS VARCHAR(50)) as Patient_Pathway_Identifier\n\t  , CASE WHEN NULLIF(path.PATIENT_PATHWAY_IDENTIFIER,'') is not null then ISNULL(path.ORGANISATION_PATIENT_PATHWAY_IDENTIFIER_ISSUER,h.ORGANISATION_CODE_OF_PROVIDER) ELSE '' END as Organisation_Identifier_Patient_Pathway_Identifier_Issuer\n\n--REFERRAL TO TREATMENT\n\t  , CASE WHEN NULLIF(path.PATIENT_PATHWAY_IDENTIFIER,'') is not null then CAST(h.RTT_PERIOD_STATUS_CODE AS VARCHAR(50)) ELSE '' END as REFERRAL_TO_TREATMENT_PERIOD_STATUS\n\t, CASE WHEN NULLIF(path.PATIENT_PATHWAY_IDENTIFIER,'') is not null  THEN CAST(h.PATHWAY_TYPE_CODE AS VARCHAR(50)) ELSE '' END as   WAITING_TIME_MEASUREMENT_TYPE_COMMISSIONING_DATASET\n      ,CAST(path.CURRENT_REFERRAL_TO_TREATMENT_PERIOD_START_DATE AS VARCHAR(50)) as REFERRAL_TO_TREATMENT_PERIOD_START_DATE\n      ,CAST(path.CURRENT_REFERRAL_TO_TREATMENT_PERIOD_STOP_DATE AS VARCHAR(50)) as REFERRAL_TO_TREATMENT_PERIOD_END_DATE\r\n\r\n--PATIENT IDENTITIY\n/*\nWITHELD STRUCTURE\nNHS_NUMBER_STATUS_INDICATOR_CODE\nORGANISATION_IDETIFIER_RESIDENCE_RESPONSIBILITY\nWITHHELD_IDENTITY_REASON\n\nVERIFIED IDENTITY STRUCTURE\n\n[LOCAL_PATIENT_IDENTIFIER_EXTENDED]\n[ORGANISATION_IDENTIFIER_LOCAL_PATIENT_IDENTIFIER]\n[NHS_NUMBER]\nNHS_NUMBER_STATUS_INDICATOR_CODE\nPOSTCODE_OF_USUAL_ADDRESS\nORGANISATION_IDENTIFIER_RESIDENCE_RESPONSIBILITY\nPERSON_BIRTH_DATE\n\nUNVERIFIED IDENTITY STRUCTURE\n\n[LOCAL_PATIENT_IDENTIFIER_EXTENDED]\n[ORGANISATION_IDENTIFIER_LOCAL_PATIENT_IDENTIFIER]\n[NHS_NUMBER]\nNHS_NUMBER_STATUS_INDICATOR_CODE\n[PERSON_TITLE]\n[PERSON_GIVEN_NAME]\n[PERSON_FAMILY_NAME]\nPATIENT_NAME_SUFFIX\nPATIENT_INITIALS\nPOSTCODE_OF_USUAL_ADDRESS\nORGANISATION_IDENTIFIER_RESIDENCE_RESPONSIBILITY\nPERSON_BIRTH_DATE\n\n*/\n\t,p.[LOCAL_PATIENT_IDENTIFIER] as LOCAL_PATIENT_IDENTIFIER_EXTENDED\n\t,CAST(left(isnull(h.ORGANISATION_CODE_OF_PROVIDER,@ORGANISATION_CODE_CODE_OF_PROVIDER_DEFAULT),3) AS VARCHAR(50))  as [ORGANISATION_IDENTIFIER_LOCAL_PATIENT_IDENTIFIER] \n\t,p.[NHS_NUMBER]\n\t,CAST(dbo.f_Leading_Zeros(isnull(p.NHS_NUMBER_STATUS_INDICATOR_CODE, '3'), 2) AS VARCHAR(50)) as NHS_NUMBER_STATUS_INDICATOR_CODE\n\t,CAST(p.[PERSON_GIVEN_NAME] AS VARCHAR(50)) as [PERSON_GIVEN_NAME]\n\t,CAST(p.[PERSON_TITLE] AS VARCHAR(50)) as [PERSON_TITLE]\n\t\t,CAST(p.PERSON_FULL_NAME AS VARCHAR(50)) as PERSON_FULL_NAME\n\t,CAST(p.[PERSON_FAMILY_NAME] AS VARCHAR(50)) [PERSON_FAMILY_NAME]\n\t,CAST('' AS VARCHAR(50)) as PATIENT_NAME_SUFFIX\r\n\t,CAST('' AS VARCHAR(50)) as PATIENT_INITIALS\n\t,cast(isnull(pa.[ADDRESS_LINE_1], '') \n\t\t+ Case When NullIf(pa.[ADDRESS_LINE_2],'') Is Null Then '' Else ', ' End\n\t\t+ isnull(pa.[ADDRESS_LINE_2], '') \n\t\t+ Case When NullIf(pa.[ADDRESS_LINE_3],'') Is Null Then '' Else ', ' End\n\t\t+ isnull(pa.[ADDRESS_LINE_3], '') \n\t\t+ Case When NullIf(pa.[ADDRESS_LINE_4],'') Is Null Then '' Else ', ' End\n\t\t+ isnull(pa.[ADDRESS_LINE_4], '')  \tAS VARCHAR(175)) as UNSTRUCTURED_ADDRESS\n\t,CAST(LEFT(ISNULL(pa.[ADDRESS_LINE_1],''),35) AS VARCHAR(50)) as [ADDRESS_LINE_1]\n\t,CAST(LEFT(ISNULL(pa.[ADDRESS_LINE_2],''),35) AS VARCHAR(50)) as [ADDRESS_LINE_2]\n\t,CAST(LEFT(pa.[ADDRESS_LINE_3],35) AS VARCHAR(50)) as [ADDRESS_LINE_3]\n\t,CAST(LEFT(pa.[ADDRESS_LINE_4],35) AS VARCHAR(50)) as [ADDRESS_LINE_4]\n\t,CAST(LEFT(pa.[ADDRESS_LINE_5],35)  AS VARCHAR(50)) as [ADDRESS_LINE_5]\n\t,CAST(a.[POSTCODE_AT_ACTIVITY_DATE] AS VARCHAR(50)) as POSTCODE_OF_USUAL_ADDRESS\n\t,CAST(isnull(a.ORGANISATION_CODE_RESIDENCE_RESPONSIBILITY, '') AS VARCHAR(50)) as ORGANISATION_IDENTIFIER_RESIDENCE_RESPONSIBILITY\n\t,CAST(CONVERT(VARCHAR(10), p.[PERSON_BIRTH_DATE],20) AS VARCHAR(20)) PERSON_BIRTH_DATE\n\t--,a.RECORD_ID\n\t,a.MODIFIED_DATE_TIME\n\t,a.ADDED_DATE_TIME\n    ,CAST(a.WITHHELD_IDENTITY_FLAG AS VARCHAR(50))  as WITHHELD_FLAG   --REQUIREDa.WITHHELD_FLAG\n    ,a.WITHHELD_IDENTITY_REASON_CODE WITHHELD_IDENTITY_REASON\n\t,CAST('02' AS VARCHAR(50)) as ADDRESS_FORMAT_CODE\n\n--PATIENT CHARACTERISTICS\n\t ,CAST(ISNULL(p.PERSON_GENDER_CODE, 'X') AS VARCHAR(50)) as PERSON_STATED_GENDER_CODE\n     ,CAST(p.CARER_SUPPORT_INDICATOR_CODE AS VARCHAR(50)) AS CARER_SUPPORT_INDICATOR\n     ,CAST(ISNULL(p.ETHNIC_CATEGORY_CODE,'99') AS VARCHAR(50))  AS ETHNIC_CATEGORY\n\t ,CAST(p.ETHNIC_CATEGORY_2021_CODE AS VARCHAR(50)) AS  ETHNIC_CATEGORY_2021\n     ,CAST(isnull(p.PERSON_MARITAL_STATUS_CODE, '9') AS VARCHAR(50)) as PERSON_MARITAL_STATUS\n\n\t ,CAST('98' AS VARCHAR(50)) as MENTAL_HEALTH_ACT_LEGAL_STATUS_CLASSIFICATION_CODE_ON_ADMISSION\n\n--PATIENT CHARACTERISTICS - SOCIAL AND PERSONAL CIRCUMSTANCES GROUP\n\t  ,CAST('' as varchar(20)) as SOCIAL_AND_PERSONAL_CIRCUMSTANCE_SNOMED_CT \r\n\r\n--HOSPITAL PROVIDER SPELL - ADMISSION CHARACTERISTICS\r\n\t,CAST(h.HOSPITAL_PROVIDER_SPELL_NUMBER AS VARCHAR(50)) as HOSPITAL_PROVIDER_SPELL_IDENTIFIER\n\t,CAST(isnull(h.ADMINISTRATIVE_CATEGORY_CODE_ON_ADMISSION, '') AS VARCHAR(50)) as ADMINISTRATIVE_CATEGORY_CODE_ON_ADMISSION\n\t,CAST(isnull(h.PATIENT_CLASSIFICATION_CODE, '') AS VARCHAR(50)) as PATIENT_CLASSIFICATION\n\t,CAST(isnull(h.ADMISSION_METHOD_CODE_HOSPITAL_PROVIDER_SPELL, '') AS VARCHAR(50)) as METHOD_OF_ADMISSION_HOSPITAL_PROVIDER_SPELL\n\t--,CAST(isnull(h.SOURCE_OF_ADMISSION_HOSPITAL_PROVIDER_SPELL_CODE, '') AS VARCHAR(50)) as ADMISSION_SOURCE_HOSPITAL_PROVIDER_SPELL -- REPLACED WITH SOURCE_OF_ADMISSION_CODE_HOSPITAL_PROVIDER_SPELL @ 1:55 04/10/23 (KE - STGH).\n\t,CAST(isnull(h.SOURCE_OF_ADMISSION_CODE_HOSPITAL_PROVIDER_SPELL, '99') AS VARCHAR(50)) as ADMISSION_SOURCE_HOSPITAL_PROVIDER_SPELL\n\t,isnull(CONVERT(VARCHAR(10),h.START_DATE_TIME_HOSPITAL_PROVIDER_SPELL,20), '') as START_DATE_HOSPITAL_PROVIDER_SPELL\n\t,CONVERT(VARCHAR(10), START_DATE_TIME_HOSPITAL_PROVIDER_SPELL,24) START_TIME_HOSPITAL_PROVIDER_SPELL\n\t,CAST(dbo.f_Leading_Zeros(h.AGE_AT_ADMISSION_DATE, 3) AS VARCHAR(50)) as AGE_ON_ADMISSION\n\n\t,CAST('' as varchar(20)) as AMBULANCE_CALL_IDENTIFIER\n\t,CAST('' as varchar(20)) as ORGANISATION_IDENTIFIER_CONVEYING_AMBULANCE_TRUST\r\n\t,CAST('' as varchar(20)) as CARE_CONTACT_IDENTIFIER_AMBULANCE_SERVICE\r\n\n--HOSPITAL PROVIDER SPELL - DISCHARGE CHARACTERISTICS\n      ,CAST(isnull(h.DISCHARGE_DESTINATION_CODE_HOSPITAL_PROVIDER_SPELL, '') AS VARCHAR(50)) as DESTINATION_OF_DISCHARGE_HOSPITAL_PROVIDER_SPELL\n      --,CAST(isnull(h.DISCHARGE_METHOD_CODE_HOSPITAL_PROVIDER_SPELL_CDS, '') AS VARCHAR(50))\n\t  ,Left(CAST(isnull(h.DISCHARGE_METHOD_CODE_HOSPITAL_PROVIDER_SPELL, '') AS VARCHAR(50)),1) as METHOD_OF_DISCHARGE_HOSPITAL_PROVIDER_SPELL\n      ,isnull(CONVERT(VARCHAR(10), h.DISCHARGE_READY_DATE_TIME,20), '') as  DISCHARGE_READY_DATE_TIME\n      ,isnull(CONVERT(VARCHAR(10), h.DISCHARGE_DATE_TIME_HOSPITAL_PROVIDER_SPELL,20), '') as DISCHARGE_DATE_HOSPITAL_PROVIDER_SPELL\n      ,CONVERT(VARCHAR(10), DISCHARGE_DATE_TIME_HOSPITAL_PROVIDER_SPELL,24)  as DISCHARGE_TIME_HOSPITAL_PROVIDER_SPELL\n      ,CAST(ISNULL(CASE a.DISCHARGE_TO_HOME_INDICATOR_PROVIDER_SPELL WHEN '1' THEN 'Y' WHEN '0' THEN 'N' END, '9') AS VARCHAR(50)) DISCHARGE_TO_NHS_AT_HOME_SERVICE_INDICATOR\r\n\r\n--CARE EPISODE - ACTIVITY CHARACTERISTICS\r\n\t   ,CAST(dbo.f_Leading_Zeros(a.EPISODE_NUMBER, 2) AS VARCHAR(50)) as EPISODE_NUMBER\n      ,cast(isnull(a.LAST_EPISODE_IN_SPELL_INDICATOR_CODE,2) as varchar(3)) LAST_EPISODE_IN_SPELL_INDICATOR_CODE\n      ,CAST(isnull(a.ADMINISTRATIVE_CATEGORY_CODE, '') AS VARCHAR(50)) as ADMINISTRATIVE_CATEGORY\n     -- ,CAST(isnull(a.OPERATION_STATUS_CODE, '') AS VARCHAR(50)) as OPERATION_STATUS_CODE\n      ,'8' as NEONATAL_LEVEL_OF_CARE_CODE--CAST(isnull(a.NEONATAL_LEVEL_OF_CARE, '') AS VARCHAR(50)) as NEONATAL_LEVEL_OF_CARE\n      ,CAST(isnull(h.FIRST_REGULAR_DAY_OR_NIGHT_ADMISSION, '') AS VARCHAR(50)) as FIRST_REGULAR_DAY_OR_NIGHT_ADMISSION_CODE --,CAST(isnull(a.FIRST_WARD_STAY_IDENTIFIER, '') AS VARCHAR(50)) \n      ,CAST(ISNULL(a.PSYCHIATRIC_PATIENT_STATUS_CODE,'8') AS VARCHAR(50)) as PSYCHIATRIC_PATIENT_STATUS_CODE\n      --,CAST('98' AS VARCHAR(50))\n      ,isnull(CONVERT(VARCHAR(10), a.EPISODE_START_DATE_TIME,20), '') as START_DATE_EPISODE\n\t  ,isnull(CONVERT(VARCHAR(10), EPISODE_START_DATE_TIME,24),'')  as START_TIME_EPISODE\n      ,isnull(CONVERT(VARCHAR(10), a.EPISODE_END_DATE_TIME,20), '') as END_DATE_EPISODE\n\t  ,isnull(CONVERT(VARCHAR(10), EPISODE_END_DATE_TIME,24),'')    as END_TIME_EPISODE\n      ,CAST(dbo.f_Leading_Zeros(a.AGE_AT_START_DATE_EPISODE, 3) AS VARCHAR(50))  as AGE_AT_CDS_ACTIVITY_DATE  --Check activity date definition\n      \n      ,CAST('' as varchar(20)) as REHABILITATION_ASSESSMENT_TEAM_TYPE\n\t\t--,''--OVERSEAS_VISITOR_STATUS\n\n--CARE EPISODE - LENGTH OF STAY ADJUSTMENT\n\t\t,CAST('' AS VARCHAR(50)) as LENGTH_OF_STAY_ADJUSTMENT_REHABILITATION\r\n\t\t,CAST('' AS VARCHAR(50)) as LENGTH_OF_STAY_ADJUSTMENT_SPECIALIST_PALLIATIVE_CARE\r\n--CARE EPISODE - OVERSEAS VISITOR CHARGING CATEGORY\r\n\t\t,CAST(isnull(a.OVERSEAS_VISITOR_CHARGING_CATEGORY_CODE,'' ) as varchar(20))  as OVERSEAS_VISITOR_CHARGING_CATEGORY\r\n\t\t,isnull(CONVERT(VARCHAR(10), a.EPISODE_START_DATE_TIME,20), '') as OVERSEAS_VISITOR_CHARGING_CATEGORY_APPLICABLE_FROM_DATE\r\n\t\t,isnull(CONVERT(VARCHAR(10), a.EPISODE_END_DATE_TIME,20), '') as OVERSEAS_VISITOR_CHARGING_CATEGORY_APPLICABLE_END_DATE\n\n--CARE EPISODE - SERVICE AGREEMENT DETAILS\n\t\t--,CAST(ISNULL('', '999999') AS VARCHAR(50)) --CHECK ID feild available\n\t\t,left(CAST(ISNULL(a.ORGANISATION_CODE_OF_PROVIDER,@ORGANISATION_CODE_CODE_OF_PROVIDER_DEFAULT) AS VARCHAR(50)),3)  as  ORGANISATION_IDENTIFIER_CODE_OF_PROVIDER  \n\t\t,CAST(ISNULL(a.ORGANISATION_CODE_OF_COMMISSIONER, @ORGANISATION_CODE_CODE_OF_COMMISSIONER_DEFAULT) AS VARCHAR(50)) as ORGANISATION_IDENTIFIER_CODE_OF_COMMISSIONER\n\t\t,CAST(a.EPISODE_START_DATE AS VARCHAR(50))  as START_DATE_COMMISSIONER_ASSIGNMENT_PERIOD\r\n\t\t,CAST(a.EPISODE_END_DATE AS VARCHAR(50))  as END_DATE_COMMISSIONER_ASSIGNMENT_PERIOD\r\n\t\t,CAST(a.SERVICE_LINE AS VARCHAR(50))  as NHS_SERVICE_AGREEMENT_IDENTIFIER\n      ,CAST(a.CONT_NHS_SRV_AGR_LN_NO AS VARCHAR(50)) as NHS_SERVICE_AGREEMENT_LINE_IDENTIFIER  --CHECK If field availableNHS_SERVICE_AGREEMENT_LINE_NUMBER\n      ,CAST(CONT_PROV_REF_NO AS VARCHAR(50)) as PROVIDER_REFERENCE_IDENTIFIER  --CHECK If field available PROVIDER_REFERENCE_NUMBER\n      ,CAST(CONT_COMM_REF_NO AS VARCHAR(50)) as COMMISSIONER_REFERENCE_IDENTIFIER --CHECK If field available \n\t    ,CAST('' AS VARCHAR(50)) as SERVICE_CODE\n\t  \r\n--CARE EPISODE - PERSON GROUP CARE PROFESSIONAL\r\n,CAST('' AS VARCHAR(50)) as  RESPONSIBLE_CARE_PROFESSIONAL_CT\r\n\r\n--CLINICAL DIAGNOSES GROUP ICD -- PRIMARY DIAGNOSIS ADJUSTED BY KE(STG) TO CATER TO SHORTER DIAG CODES REQUIRING A SUFFIX 'X'\n      ,CAST('02' as varchar(2)) as DIAGNOSIS_SCHEME_IN_USE_COMMISSIONING_DATASET\n     -- ,CAST(REPLACE(pd.DIAGNOSIS_01,'.','') AS VARCHAR(50)) as PRIMARY_DIAGNOSIS_ICD \r\n\t ,CAST(REPLACE(CASE WHEN LEN(pd.DIAGNOSIS_01) = 3 THEN pd.DIAGNOSIS_01 + 'X' ELSE pd.DIAGNOSIS_01 END,'.','') AS VARCHAR(50)) as PRIMARY_DIAGNOSIS_ICD\r\n\t ,CAST('9' AS VARCHAR(50)) AS PRESENT_ON_ADMISSION_INDICATOR\r\n\r\n--CLINICAL DIAGNOSIS SECONDARY ICD GROUP\r\n\t,cast('' as varchar(max) ) as  SECONDARY_DIAGNOSIS_CT\r\n\r\n--CARE EPISODE - CLINICAL DIAGNOSIS GROUP SNOMED \r\n\t  ,CAST('' as varchar(max)) as CARE_EPISODE_CLINICAL_DIAGNOSIS_GROUP_SNOMED_CT\r\n\r\n--CARE EPISODE - COMORBIDITY (SNOMED CT)\r\n\t ,CAST('' as varchar(max)) as CARE_EPISODE_COMORBIDITY_GROUP_SNOMED_CT\r\n\r\n--CARE EPISODE - EMED3 FIT NOTE\r\n\t,CAST('' AS VARCHAR(50))  AS EMED3_FIT_NOTE_ASSESSMENT_DATE\r\n\t,CAST('' AS VARCHAR(50))   AS EMED3_FIT_NOTE_CONDITION_SNOMED_CT_EXPRESSION\r\n\t,CAST('' AS VARCHAR(50)) AS EMED3_FIT_NOTE_DIAGNOSIS_ICD\r\n\t,CAST('' AS VARCHAR(50)) AS EMED3_FIT_NOTE_START_DATE\r\n\t,CAST('' AS VARCHAR(50)) AS EMED3_FIT_NOTE_END_DATE\r\n\t,CAST('' AS VARCHAR(50))  AS EMED3_FIT_NOTE_DURATION\r\n\t,CAST('' AS VARCHAR(50))  AS EMED3_FIT_NOTE_RECORDED_DATE\r\n\t,CAST('' AS VARCHAR(50)) AS  EMED3_FIT_NOTE_FOLLOW_UP_ASSESSMENT_REQUIRED_INDICATOR\r\n\t,CAST('' AS VARCHAR(50)) AS  EMED3_FIT_NOTE_ISSUER\r\n\r\n--CARE EPISODE - PROCEDURE GROUP (OPCS)\r\n\t,CAST('02' as varchar(2)) AS  PROCEDURE_SCHEME_IN_USE_COMMISSIONING_DATA_SET\n\t,CAST(replace(pp.[PROCEDURE_CODE_01],'.','') AS VARCHAR(50)) as PRIMARY_PROCEDURE\n\t,isnull(CONVERT(VARCHAR(10), pp.PROCEDURE_DATE_01,20), '')    AS PROCEDURE_DATE\r\n\t,CAST('' AS VARCHAR(50)) AS PROFESSIONAL_REGISTRATION_ISSUER_CODE\r\n\t,ISNULL(CAST(ISNULL(CARE_PROFESSIONAL_IDENTIFIER_CODE,CONSULTANT_CODE) AS VARCHAR(50)),'') AS PROFESSIONAL_REGISTRATION_ENTRY_IDENTIFIER_MAIN_OPERATING_CARE_PROFESSIONAL\r\n\t,CAST('' AS VARCHAR(50)) AS PROFESSIONAL_REGISTRATION_ISSUER_CODE_ANAESTHETIST\r\n\t,CAST('' AS VARCHAR(50)) AS PROFESSIONAL_REGISTRATION_ENTRY_IDENTIFIER_RESPONSIBLE_ANAESTHETIST\r\n\r\n--SECONDARY PROCEDURES (OPCS)\n\t,CAST('' as varchar(max)) as SECONDARY_PROCEDURES_CT\n\n--CARE EPISODE - PROCEDURE GROUP (SNOMED CT)\n\t,CAST('' as varchar(max)) as CARE_EPISODE_PROCEDURE_GROUP_SNOMED_CT\n\n--CARE EPISODE - OBSERVATION GROUP (SNOMED CT)\n\t,CAST('' as varchar(max)) as CARE_EPISODE_OBSERVATION_GROUP_SNOMED_CT\n\n--CARE EPISODE - FINDING GROUP (SNOMED CT)\n\t,CAST('' as varchar(max)) as CARE_EPISODE_FINDING_GROUP_SNOMED_CT\n\n--CARE EPISODE - ASSESSMENT TOOL GROUP (SNOMED CT)\n\t,CAST('' as varchar(max)) as CARE_EPISODE_ASSESSMENT_TOOL_GROUP_SNOMED_CT\n\n --LOCATION GROUP (AT START OF CARE EPISODE)\n       ,CAST(isnull(ws.SITE_CODE_OF_TREATMENT, lws.SITE_CODE_OF_TREATMENT) AS VARCHAR(50)) as ORGANISATION_SITE_IDENTIFIER_OF_TREATMENT\n      ,CAST(isnull(NULL, '') AS VARCHAR(50)) as ACTIVITY_LOCATION_TYPE_CODE\n      ,CAST(isnull(ws.INTENDED_CLINICAL_CARE_INTENSITY_CODE, '') AS VARCHAR(50)) as WARD_INTENDED_CLINICAL_CARE_INTENSITY\n      ,CAST(isnull(ws.INTENDED_AGE_GROUP_CODE, '') AS VARCHAR(50)) as WARD_INTENDED_AGE_GROUP  --ws.INTENDED_AGE_GROUP\n      ,CAST(isnull(ws.SEX_OF_PATIENTS_CODE, '') AS VARCHAR(50)) as WARD_INTENDED_SEX_OF_PATIENTS\n      ,CAST(isnull(ws.WARD_DAY_PERIOD_AVAILABILITY_CODE, '0') AS VARCHAR(50)) as WARD_INTENDED_DAY_PERIOD_AVAILABILITY\n      ,CAST(isnull(ws.WARD_NIGHT_PERIOD_AVAILABILITY_CODE, '0') AS VARCHAR(50)) as WARD_INTENDED_NIGHT_PERIOD_AVAILABILITY\n    --  ,isnull(CONVERT(VARCHAR(8), ws.WARD_STAY_END_DATE_TIME,112), '') as WARD_STAY_END_DATE\n     -- ,ISNULL(CONVERT(varchar(6), REPLACE(convert(varchar(8), ws.WARD_STAY_END_DATE_TIME, 114),':','') ),'') as WARD_STAY_END_TIME\n     -- ,isnull(CONVERT(VARCHAR(8), ws.WARD_STAY_START_DATE_TIME,112), '') as WARD_STAY_START_DATE\n      --,ISNULL(CONVERT(varchar(6), REPLACE(convert(varchar(8), ws.WARD_STAY_START_DATE_TIME, 114),':','') ),'') as WARD_STAY_START_TIME\n      ,ISNULL('','0') as WARD_SECURITY_LEVEL  -- ws.WARD_SECURITY_LEVEL\n      --,CAST(ws.WARD_LOCAL_ID as varchar(max)) as WARD_CODE\n\t  --,CAST(LEFT(dbo.REMOVESPECIALCHARS(h.ADMITTING_WARD_CODE),12) as varchar(12)) as WARD_CODE\n\t  ,ISNULL(CAST(ws.WARD_LOCAL_ID as varchar(12)), '') as WARD_CODE\n     -- ,dbo.f_Leading_Zeros( WARD_STAY_ORDER,3)\n     -- ,'04'\n\n\t \n\n--LOCATION GROUP (AT WARD STAY)\n\t,CAST('' as varchar(max)) as LOCATION_GROUP_AT_WARD_STAY_CT\n\n--LOCATION GROUP (AT END OF CARE EPISODE)\n\t,CAST(isnull(lws.SITE_CODE_OF_TREATMENT,isnull(a.SITE_CODE_OF_TREATMENT,'')) AS VARCHAR(50)) as ORGANISATION_SITE_IDENTIFIER_OF_TREATMENT_LAST_EPI\n      ,CAST(isnull(NULL, '') AS VARCHAR(50)) as ACTIVITY_LOCATION_TYPE_CODE_LAST_EPI\n      ,CAST(isnull(LWS.INTENDED_CLINICAL_CARE_INTENSITY_CODE, '') AS VARCHAR(50)) as WARD_INTENDED_CLINICAL_CARE_INTENSITY_LAST_EPI\n      ,CAST(isnull(lws.INTENDED_AGE_GROUP_CODE, '') AS VARCHAR(50)) as WARD_INTENDED_AGE_GROUP_LAST_EPI --LWS.INTENDED_AGE_GROUP\n      ,CAST(isnull(LWS.SEX_OF_PATIENTS_CODE, '') AS VARCHAR(50)) as WARD_INTENDED_SEX_OF_PATIENTS_LAST_EPI\n      ,CAST(isnull(LWS.WARD_DAY_PERIOD_AVAILABILITY_CODE, '0') AS VARCHAR(50)) as WARD_INTENDED_DAY_PERIOD_AVAILABILITY_LAST_EPI\n      ,CAST(isnull(LWS.WARD_NIGHT_PERIOD_AVAILABILITY_CODE, '0') AS VARCHAR(50)) as WARD_INTENDED_NIGHT_PERIOD_AVAILABILITY_LAST_EPI\n      --,isnull(CONVERT(VARCHAR(8), LWS.WARD_STAY_END_DATE_TIME,112), '') as WARD_STAY_END_DATE_LAST_EPI\n     -- ,ISNULL(CONVERT(varchar(6), REPLACE(convert(varchar(8), LWS.WARD_STAY_END_DATE_TIME, 114),':','') ),'') WARD_STAY_END_TIME_LAST_EPI\n     -- ,isnull(CONVERT(VARCHAR(8), ws.WARD_STAY_START_DATE_TIME,112), '') as WARD_STAY_START_DATE_LAST_EPI\n     -- ,ISNULL(CONVERT(varchar(6), REPLACE(convert(varchar(8), LWS.WARD_STAY_START_DATE_TIME, 114),':','') ),'') as WARD_STAY_START_TIME_LAST_EPI\n      ,ISNULL('','0') as WARD_SECURITY_LEVEL_LAST_EPI --LWS.WARD_SECURITY_LEVEL\n      --,CAST(ws.WARD_LOCAL_ID as varchar(max)) as WARD_CODE_LAST_EPI\n\t  -- ,CAST(LEFT(dbo.REMOVESPECIALCHARS(h.DISCHARGING_WARD_CODE),12) as varchar(12)) as WARD_CODE_LAST_EPI\n\t  ,ISNULL(CAST(LWS.WARD_LOCAL_ID as varchar(12)), '') as WARD_CODE_LAST_EPI\n-- ,dbo.f_Leading_Zeros( WARD_STAY_ORDER,3)\n-- ,'04'\n--LOCATION GROUP - HOME LEAVE\n\t,CAST('' as varchar(max)) as LOCATION_GROUP_HOME_LEAVE\n--CARE EPISODE - NEONATAL CRITICAL CARE PERIOD\n\r\n----ADmission Charachteristicd\r\n --CRITICAL CARE LOCAL IDENTIFIER\r\n-- CRITICAL CARE START DATE\r\n--CRITICAL CARE END DATE\r\n--CRITICAL CARE UNIT FUNCTION\r\n--GESTATION LENGTH (AT DELIVERY)\r\n\r\n\t,CAST('' as varchar(max)) as CARE_EPISODE_NEONATAL_CRITICAL_CARE_PERIOD_CT\r\n----Discharge Charachteristics\r\n--CRITICAL CARE DISCHARGE DATE\r\n--CRITICAL CARE DISCHARGE TIME\r\n\r\n\n--CARE EPISODE - PAEDIATRIC CRITICAL CARE PERIOD\n--CRITICAL CARE LOCAL IDENTIFIER\r\n--CRITICAL CARE START DATE\r\n--CRITICAL CARE START TIME\r\n--CRITICAL CARE UNIT FUNCTION\r\n\n\t,CAST('' as varchar(max)) as CARE_EPISODE_PAEDIATRIC_CRITICAL_CARE_PERIOD_CT\r\n\r\n--CRITICAL CARE DISCHARGE DATE\r\n--CRITICAL CARE DISCHARGE TIME\r\n\r\n\n--ADULT CRITICAL CARE - ADMISSION CHARACTERISTICS\n\n--CRITICAL CARE LOCAL IDENTIFIER\r\n--CRITICAL CARE START DATE\r\n--CRITICAL CARE START TIME\r\n--CRITICAL CARE UNIT FUNCTION\r\n--CRITICAL CARE UNIT BED CONFIGURATION\r\n--CRITICAL CARE ADMISSION SOURCE\r\n--CRITICAL CARE SOURCE LOCATION\r\n--CRITICAL CARE ADMISSION TYPE\r\n\r\n--ADULT CRITICAL CARE ACTIVCITY CHARACHTERISTICS\r\n--ADVANCED RESPIRATORY SUPPORT DAYS\r\n--BASIC RESPIRATORY SUPPORT DAYS\r\n--ADVANCED CARDIOVASCULAR SUPPORT DAYS\r\n--BASIC CARDIOVASCULAR SUPPORT DAYS\r\n--RENAL SUPPORT DAYS\r\n--NEUROLOGICAL SUPPORT DAYS\r\n--GASTRO-INTESTINAL SUPPORT DAYS\r\n--DERMATOLOGICAL SUPPORT DAYS\r\n--LIVER SUPPORT DAYS\r\n--ORGAN SUPPORT MAXIMUM\r\n--CRITICAL CARE LEVEL 2 DAYS\r\n--CRITICAL CARE LEVEL 3 DAYS\r\n\r\n\t,CAST('' as varchar(max)) as ADULT_CRITICAL_CARE_ACTIVITY_CHARACTERISTICS\n\n--ADULT CRITICAL CARE - DISCHARGE CHARACTERISTICS\n--CRITICAL CARE DISCHARGE DATE\r\n--CRITICAL CARE DISCHARGE TIME\r\n--CRITICAL CARE DISCHARGE READY DATE\r\n--CRITICAL CARE DISCHARGE READY TIME\r\n--CRITICAL CARE DISCHARGE STATUS\r\n--CRITICAL CARE DISCHARGE DESTINATION\r\n--CRITICAL CARE DISCHARGE LOCATION\r\n\n--GP REGISTRATION\n\t,ISNULL(a.GENERAL_MEDICAL_PRACTITIONER, 'X9999998') as GENERAL_MEDICAL_PRACTITIONER_SPECIFIED\n\t,isnull(a.GENERAL_MEDICAL_PRACTICE_CODE, 'X99998') as GENERAL_MEDICAL_PRACTICE_PATIENT_REGISTRATION\n\n--REFERRER\n\t,CAST(ISNULL('', '') AS VARCHAR(50)) REFERRER_CODE\n\t,CAST(isnull('', '') AS VARCHAR(50)) ORGANISATION_IDENTIFIER_REFERRING_ORGANISATION\n\n--REFERRAL\n\t, CAST('' as varchar(20)) as DIRECT_ACCESS_REFERRAL_INDICATOR\n\n--ELECTIVE ADMISSION LIST ENTRY\n\t,ISNULL(CAST(h.DURATION_OF_ELECTIVE_WAIT AS VARCHAR(4)),'') as DURATION_OF_ELECTIVE_WAIT\n\t,ISNULL(CAST(h.INTENDED_MANAGEMENT_CODE AS VARCHAR(50)),'') as INTENDED_MANAGEMENT_CODE\n\t,ISNULL(CONVERT(VARCHAR(10),h.DECIDED_TO_ADMIT_DATE, 20),'') as DECIDED_TO_ADMIT_DATE\n\t,ISNULL(CONVERT(VARCHAR(10),h.EARLIEST_REASONABLE_OFFER_DATE_TIME, 20),'') as EARLIEST_REASONABLE_OFFER_DATE_TIME\n\t,CAST('' as varchar(20)) as EARLIEST_CLINICALLY_APPROPRIATE_DATE\r\n\t,CAST('' as varchar(20)) as LATEST_CLINICALLY_APPROPRIATE_DATE\r\n\t\r\n--SELEcT count(*)\nFROM INP_CONSULTANT_EPISODE_HOSPITAL_PROVIDER_SPELL a\n\tLEFT JOIN INP_HOSPITAL_PROVIDER_SPELL h ON a.HOSPITAL_PROVIDER_SPELL_RECORD_ID = h.RECORD_ID\n\tinner JOIN INP_PATIENT p ON a.PATIENT_RECORD_ID = p.RECORD_ID\n\tLEFT JOIN INP_PATIENT_ADDRESS pa ON pa.RECORD_ID = a.PATIENT_ADDRESS_RECORD_ID\r\n\tLEFT JOIN INP_CONSULTANT_EPISODE_HOSPITAL_PROVIDER_SPELL_DIAGNOSIS_SR pd on pd.CONSULTANT_EPISODE_HOSPITAL_PROVIDER_SPELL_RECORD_ID = a.RECORD_ID and pd.DIAGNOSIS_SCHEME_IN_USE = 'ICD10'\r\n\tLEFT JOIN  INP_CONSULTANT_EPISODE_HOSPITAL_PROVIDER_SPELL_PROCEDURE_SR pp on pp.CONSULTANT_EPISODE_HOSPITAL_PROVIDER_SPELL_RECORD_ID = a.RECORD_ID and PROCEDURE_SCHEME_IN_USE = 'OPCS4'\r\n\tLEFT JOIN INP_CONSULTANT_EPISODE_HOSPITAL_PROVIDER_SPELL_WARD_STAY WS on ws.CONSULTANT_EPISODE_HOSPITAL_PROVIDER_SPELL_RECORD_ID = a.RECORD_ID AND ws.FIRST_WARD_FLAG = 1\r\n\tLEFT JOIN INP_CONSULTANT_EPISODE_HOSPITAL_PROVIDER_SPELL_WARD_STAY LWS on LWS.CONSULTANT_EPISODE_HOSPITAL_PROVIDER_SPELL_RECORD_ID = a.RECORD_ID AND LWS.LAST_WARD_FLAG = 1\r\n\t--LEFT JOIN INP_PATHWAY path on path.PATIENT_PATHWAY_IDENTIFIER = h.PATIENT_PATHWAY_IDENTIFIER\r\n\tLEFT JOIN (SELECT * ,Row_order = ROW_NUMBER() OVER ( PARTITION BY PATIENT_PATHWAY_IDENTIFIER ORDER BY ADDED_DATE_TIME desc)  FROM INP_PATHWAY) path on path.PATIENT_PATHWAY_IDENTIFIER = h.PATIENT_PATHWAY_IDENTIFIER and path.PATIENT_SOURCE_ID = h.PATIENT_SOURCE_ID and Row_order =1\r\n\r\n\t--508208\r\n\r\nWHERE \r\n\ta.ACTIVITY_DATE_TIME >= '2023-04-01' AND\r\n\t(ws.FIRST_WARD_FLAG = 1 or ws.FIRST_WARD_FLAG is null) and (LWS.LAST_WARD_FLAG = 1 or LWS.LAST_WARD_FLAG is null)\r\n\tand a.ACTIVE_FLAG=1\r\n\t--and CDS_BATCH_CONTENT_ID is not null\r\n\t--and a.ACTIVITY_DATE_TIME < GETDATE()\r\nGO\r\n"}
{"SQLID":300000053,"OperationSQL":"/* Operation Name :  Build master table \n Add Rule Description here.*/\n /* Operation Name :  Load to Import \n Add Rule Description here.*/\n\n/*Docstart\n2024-06-04 Paul Bigg\nBuild of the staging for main CDS data table (INP_CDS_63_INPATIENT_MAIN) for all in-flight data after successfull BEDROCK data run.\nIn-flight data could be a full data run or a delta run of altered data.  \nOne record is a single FINISHED CONSULTANT EPISODE\nRestiricted to records from INP_CONSULTANT_EPISODE_HOSPITAL_PROVIDER_SPELL where Active_Flag =1\n\nSOURCE TABLES:\n\tINP_CONSULTANT_EPISODE_HOSPITAL_PROVIDER_SPELL (Finished episode details)\n\tINP_HOSPITAL_PROVIDER_SPELL (Hospital Spell details)\n\tPATIENT (Demographic Details)  - Equi join as patient record is required\n\tPATIENT_ADDRESS (Address at activity date)\r\n\tINP_CONSULTANT_EPISODE_HOSPITAL_PROVIDER_SPELL_DIAGNOSIS_SR WHERE DIAGNOSIS_SCHEME_IN_USE = 'ICD10' (episodic diagnoses)\r\n\tINP_CONSULTANT_EPISODE_HOSPITAL_PROVIDER_SPELL_PROCEDURE_SR WHERE PROCEDURE_SCHEME_IN_USE = 'OPCS4' (episodic procedures)\r\n\tINP_CONSULTANT_EPISODE_HOSPITAL_PROVIDER_SPELL_WARD_STAY WHERE FIRST_WARD_FLAG = 1 (First ward in spell)\r\n\tINP_CONSULTANT_EPISODE_HOSPITAL_PROVIDER_SPELL_WARD_STAY WHERE LAST_WARD_FLAG = 1 (Last ward in spell)\r\n\tPATHWAY (Patient Pathway information)\n\nAMENDMENTS:\n\tv1-Script created\n\nDocend*/\n\n /*\r\nSelect * Into [INP_CDS_63_INPATIENT_MAIN] From [INP_CDS_INPATIENT_GENERAL] Where 1=2\r\nAlter Table INP_CDS_63_INPATIENT_MAIN Add EXTRACT_RECORD_ID Bigint, SUBMITTED_FLAG Bit, HASHVAL Varchar(100)\r\nSelect * Into [CDS_63_INPATIENT_MAIN] From [INP_CDS_63_INPATIENT_MAIN] Where 1=2\r\nSelect * Into [ARC_CDS_63_INPATIENT_MAIN] From [INP_CDS_63_INPATIENT_MAIN] Where 1=2\r\nSelect * Into [TMP_CDS_63_INPATIENT_MAIN] From [INP_CDS_63_INPATIENT_MAIN] Where 1=2\r\n\r\nAlter Table TMP_ECDS_30_MAIN Add EXTRACT_RECORD_ID Bigint, SUBMITTED_FLAG Bit, HASHVAL Varchar(100)\r\nAlter Table ECDS_30_MAIN Add EXTRACT_RECORD_ID Bigint, SUBMITTED_FLAG Bit, HASHVAL Varchar(100)\r\nAlter Table ARC_ECDS_30_MAIN Add EXTRACT_RECORD_ID Bigint, SUBMITTED_FLAG Bit, HASHVAL Varchar(100)\r\nAlter Table INP_ECDS_30_MAIN Add EXTRACT_RECORD_ID Bigint, SUBMITTED_FLAG Bit, HASHVAL Varchar(100)\r\n*/\n\ndelete INP_CDS_63_INPATIENT_MAIN\n\n set dateformat  dmy\n\t\n\tDeclare @CDS_INTERCHANGE_SENDER_IDENTITY varchar(50)\r\n\tDeclare @CDS_SENDER_IDENTITY varchar(10)\r\n\tDeclare @CDS_ORGANISATIONN_SITE_DEFAULT varchar(10)\r\n\tDeclare @ORGANISATION_CODE_CODE_OF_PROVIDER_DEFAULT varchar(10)\r\n\tDeclare @ORGANISATION_IDENTIFIER varchar(10)\r\n\tDeclare @ORGANISATION_CODE_CODE_OF_COMMISSIONER_DEFAULT varchar(10)\r\n\t\r\n\tset @CDS_INTERCHANGE_SENDER_IDENTITY = [dbo].[udf_GetParameter]('CDS_INTERCHANGE_SENDER_IDENTITY')\r\n\tset @CDS_SENDER_IDENTITY = [dbo].[udf_GetParameter]('CDS_SENDER_IDENTITY')\r\n\tset @CDS_ORGANISATIONN_SITE_DEFAULT =  [dbo].[udf_GetParameter]('CDS_DEFAULT_ORGANISATION_SITE')\r\n\tset @ORGANISATION_CODE_CODE_OF_PROVIDER_DEFAULT = ISNULL([dbo].[udf_GetParameter]('ORGANISATION_CODE_CODE_OF_PROVIDER'),[dbo].[udf_GetParameter]('ORGANISATION_CODE_OF_PROVIDER'))\r\n\tset @ORGANISATION_IDENTIFIER = [dbo].[udf_GetParameter]('CDS_SENDER_IDENTITY')\n\tset @ORGANISATION_CODE_CODE_OF_COMMISSIONER_DEFAULT = [dbo].[udf_GetParameter]('ORGANISATION_CODE_DEFAULT_COMMISSIONER_CDS')\n\n\n\nINSERT INTO [dbo].[INP_CDS_63_INPATIENT_MAIN]\r\n           ([RECORD_ID]\r\n           ,[CONSULTANT_EPISODE_HOSPITAL_PROVIDER_SPELL_RECORD_ID]\r\n           ,[PATIENT_RECORD_ID]\r\n           ,[CONSULTANT_EPISODE_HOSPITAL_PROVIDER_SPELL_SOURCE_ID]\r\n           ,[LINE_ID_01]\r\n           ,[CDS_VERSION]\r\n           ,[CDS_TYPE]\r\n           ,[CDS_PROTOCOL_ID]\r\n           ,[CDS_UNIQUE_ID]\r\n           ,[CDS_BULK_REPLACEMENT_GROUP]\r\n           ,[CDS_UPDATE_TYPE]\r\n           ,[CDS_EXTRACT_DATE]\r\n           ,[CDS_EXTRACT_TIME]\r\n           ,[CDS_APPLICABLE_DATE]\r\n           ,[CDS_APPLICABLE_TIME]\r\n           ,[CDS_REPORT_PERIOD_START_DATE]\r\n           ,[CDS_REPORT_PERIOD_END_DATE]\r\n           ,[CDS_ACTIVITY_DATE]\r\n           ,[CDS_TEST_INDICATOR]\r\n           ,[ORGANISATION_IDENTIFIER_CDS_SENDER]\r\n           ,[ORGANISATION_IDENTIFIER_CDS_RECIPIENT]\r\n           ,[RECORD_CONNECTION_IDENTIFIER_01]\r\n           ,[NAME_FORMAT_CODE]\r\n           ,[CDS_PRIMARY_RECIPIENT]\r\n           ,[CDS_COPY_RECIPIENT_01]\r\n           ,[CDS_COPY_RECIPIENT_02]\r\n           ,[CDS_COPY_RECIPIENT_03]\r\n           ,[CDS_COPY_RECIPIENT_04]\r\n           ,[CDS_COPY_RECIPIENT_05]\r\n           ,[Unique_Booking_ReferenceNumber_Converted]\r\n           ,[Patient_Pathway_Identifier]\r\n           ,[Organisation_Identifier_Patient_Pathway_Identifier_Issuer]\r\n           ,[REFERRAL_TO_TREATMENT_PERIOD_STATUS]\r\n           ,[WAITING_TIME_MEASUREMENT_TYPE_COMMISSIONING_DATASET]\r\n           ,[REFERRAL_TO_TREATMENT_PERIOD_START_DATE]\r\n           ,[REFERRAL_TO_TREATMENT_PERIOD_END_DATE]\r\n           ,[LOCAL_PATIENT_IDENTIFIER_EXTENDED]\r\n           ,[ORGANISATION_IDENTIFIER_LOCAL_PATIENT_IDENTIFIER]\r\n           ,[NHS_NUMBER]\r\n           ,[NHS_NUMBER_STATUS_INDICATOR_CODE]\r\n           ,[PERSON_GIVEN_NAME]\r\n           ,[PERSON_TITLE]\r\n           ,[PERSON_FULL_NAME]\r\n           ,[PERSON_FAMILY_NAME]\r\n           ,[PATIENT_NAME_SUFFIX]\r\n           ,[PATIENT_INITIALS]\r\n           ,[UNSTRUCTURED_ADDRESS]\r\n           ,[ADDRESS_LINE_1]\r\n           ,[ADDRESS_LINE_2]\r\n           ,[ADDRESS_LINE_3]\r\n           ,[ADDRESS_LINE_4]\r\n           ,[ADDRESS_LINE_5]\r\n           ,[POSTCODE_OF_USUAL_ADDRESS]\r\n           ,[ORGANISATION_IDENTIFIER_RESIDENCE_RESPONSIBILITY]\r\n           ,[PERSON_BIRTH_DATE]\r\n           ,[MODIFIED_DATE_TIME]\r\n           ,[ADDED_DATE_TIME]\r\n           ,[WITHHELD_FLAG]\r\n           ,[WITHHELD_IDENTITY_REASON]\r\n           ,[ADDRESS_FORMAT_CODE]\r\n           ,[PERSON_STATED_GENDER_CODE]\r\n           ,[CARER_SUPPORT_INDICATOR]\r\n           ,[ETHNIC_CATEGORY]\r\n           ,[ETHNIC_CATEGORY_2021]\r\n           ,[PERSON_MARITAL_STATUS]\r\n           ,[MENTAL_HEALTH_ACT_LEGAL_STATUS_CLASSIFICATION_CODE_ON_ADMISSION]\r\n           ,[SOCIAL_AND_PERSONAL_CIRCUMSTANCE_SNOMED_CT]\r\n           ,[HOSPITAL_PROVIDER_SPELL_IDENTIFIER]\r\n           ,[ADMINISTRATIVE_CATEGORY_CODE_ON_ADMISSION]\r\n           ,[PATIENT_CLASSIFICATION]\r\n           ,[METHOD_OF_ADMISSION_HOSPITAL_PROVIDER_SPELL]\r\n           ,[ADMISSION_SOURCE_HOSPITAL_PROVIDER_SPELL]\r\n           ,[START_DATE_HOSPITAL_PROVIDER_SPELL]\r\n           ,[START_TIME_HOSPITAL_PROVIDER_SPELL]\r\n           ,[AGE_ON_ADMISSION]\r\n           ,[AMBULANCE_CALL_IDENTIFIER]\r\n           ,[ORGANISATION_IDENTIFIER_CONVEYING_AMBULANCE_TRUST]\r\n           ,[CARE_CONTACT_IDENTIFIER_AMBULANCE_SERVICE]\r\n           ,[DESTINATION_OF_DISCHARGE_HOSPITAL_PROVIDER_SPELL]\r\n           ,[METHOD_OF_DISCHARGE_HOSPITAL_PROVIDER_SPELL]\r\n           ,[DISCHARGE_READY_DATE_TIME]\r\n           ,[DISCHARGE_DATE_HOSPITAL_PROVIDER_SPELL]\r\n           ,[DISCHARGE_TIME_HOSPITAL_PROVIDER_SPELL]\r\n           ,[DISCHARGE_TO_NHS_AT_HOME_SERVICE_INDICATOR]\r\n           ,[EPISODE_NUMBER]\r\n           ,[LAST_EPISODE_IN_SPELL_INDICATOR_CODE]\r\n           ,[ADMINISTRATIVE_CATEGORY]\r\n           ,[NEONATAL_LEVEL_OF_CARE_CODE]\r\n           ,[FIRST_REGULAR_DAY_OR_NIGHT_ADMISSION_CODE]\r\n           ,[PSYCHIATRIC_PATIENT_STATUS_CODE]\r\n           ,[START_DATE_EPISODE]\r\n           ,[START_TIME_EPISODE]\r\n           ,[END_DATE_EPISODE]\r\n           ,[END_TIME_EPISODE]\r\n           ,[AGE_AT_CDS_ACTIVITY_DATE]\r\n           ,[REHABILITATION_ASSESSMENT_TEAM_TYPE]\r\n           ,[LENGTH_OF_STAY_ADJUSTMENT_REHABILITATION]\r\n           ,[LENGTH_OF_STAY_ADJUSTMENT_SPECIALIST_PALLIATIVE_CARE]\r\n           ,[OVERSEAS_VISITOR_CHARGING_CATEGORY]\r\n           ,[OVERSEAS_VISITOR_CHARGING_CATEGORY_APPLICABLE_FROM_DATE]\r\n           ,[OVERSEAS_VISITOR_CHARGING_CATEGORY_APPLICABLE_END_DATE]\r\n           ,[ORGANISATION_IDENTIFIER_CODE_OF_PROVIDER]\r\n           ,[ORGANISATION_IDENTIFIER_CODE_OF_COMMISSIONER]\r\n           ,[START_DATE_COMMISSIONER_ASSIGNMENT_PERIOD]\r\n           ,[END_DATE_COMMISSIONER_ASSIGNMENT_PERIOD]\r\n           ,[NHS_SERVICE_AGREEMENT_IDENTIFIER]\r\n           ,[NHS_SERVICE_AGREEMENT_LINE_IDENTIFIER]\r\n           ,[PROVIDER_REFERENCE_IDENTIFIER]\r\n           ,[COMMISSIONER_REFERENCE_IDENTIFIER]\r\n           ,[SERVICE_CODE]\r\n           ,[RESPONSIBLE_CARE_PROFESSIONAL_CT]\r\n           ,[DIAGNOSIS_SCHEME_IN_USE_COMMISSIONING_DATASET]\r\n           ,[PRIMARY_DIAGNOSIS_ICD]\r\n           ,[PRESENT_ON_ADMISSION_INDICATOR]\r\n           ,[SECONDARY_DIAGNOSIS_CT]\r\n           ,[CARE_EPISODE_CLINICAL_DIAGNOSIS_GROUP_SNOMED_CT]\r\n           ,[CARE_EPISODE_COMORBIDITY_GROUP_SNOMED_CT]\r\n           ,[EMED3_FIT_NOTE_ASSESSMENT_DATE]\r\n           ,[EMED3_FIT_NOTE_CONDITION_SNOMED_CT_EXPRESSION]\r\n           ,[EMED3_FIT_NOTE_DIAGNOSIS_ICD]\r\n           ,[EMED3_FIT_NOTE_START_DATE]\r\n           ,[EMED3_FIT_NOTE_END_DATE]\r\n           ,[EMED3_FIT_NOTE_DURATION]\r\n           ,[EMED3_FIT_NOTE_RECORDED_DATE]\r\n           ,[EMED3_FIT_NOTE_FOLLOW_UP_ASSESSMENT_REQUIRED_INDICATOR]\r\n           ,[EMED3_FIT_NOTE_ISSUER]\r\n           ,[PROCEDURE_SCHEME_IN_USE_COMMISSIONING_DATA_SET]\r\n           ,[PRIMARY_PROCEDURE]\r\n           ,[PROCEDURE_DATE]\r\n           ,[PROFESSIONAL_REGISTRATION_ISSUER_CODE]\r\n           ,[PROFESSIONAL_REGISTRATION_ENTRY_IDENTIFIER_MAIN_OPERATING_CARE_PROFESSIONAL]\r\n           ,[PROFESSIONAL_REGISTRATION_ISSUER_CODE_ANAESTHETIST]\r\n           ,[PROFESSIONAL_REGISTRATION_ENTRY_IDENTIFIER_RESPONSIBLE_ANAESTHETIST]\r\n           ,[SECONDARY_PROCEDURES_CT]\r\n           ,[CARE_EPISODE_PROCEDURE_GROUP_SNOMED_CT]\r\n           ,[CARE_EPISODE_OBSERVATION_GROUP_SNOMED_CT]\r\n           ,[CARE_EPISODE_FINDING_GROUP_SNOMED_CT]\r\n           ,[CARE_EPISODE_ASSESSMENT_TOOL_GROUP_SNOMED_CT]\r\n           ,[ORGANISATION_SITE_IDENTIFIER_OF_TREATMENT]\r\n           ,[ACTIVITY_LOCATION_TYPE_CODE]\r\n           ,[WARD_INTENDED_CLINICAL_CARE_INTENSITY]\r\n           ,[WARD_INTENDED_AGE_GROUP]\r\n           ,[WARD_INTENDED_SEX_OF_PATIENTS]\r\n           ,[WARD_INTENDED_DAY_PERIOD_AVAILABILITY]\r\n           ,[WARD_INTENDED_NIGHT_PERIOD_AVAILABILITY]\r\n           ,[WARD_SECURITY_LEVEL]\r\n           ,[WARD_CODE]\r\n           ,[LOCATION_GROUP_AT_WARD_STAY_CT]\r\n           ,[ORGANISATION_SITE_IDENTIFIER_OF_TREATMENT_LAST_EPI]\r\n           ,[ACTIVITY_LOCATION_TYPE_CODE_LAST_EPI]\r\n           ,[WARD_INTENDED_CLINICAL_CARE_INTENSITY_LAST_EPI]\r\n           ,[WARD_INTENDED_AGE_GROUP_LAST_EPI]\r\n           ,[WARD_INTENDED_SEX_OF_PATIENTS_LAST_EPI]\r\n           ,[WARD_INTENDED_DAY_PERIOD_AVAILABILITY_LAST_EPI]\r\n           ,[WARD_INTENDED_NIGHT_PERIOD_AVAILABILITY_LAST_EPI]\r\n           ,[WARD_SECURITY_LEVEL_LAST_EPI]\r\n           ,[WARD_CODE_LAST_EPI]\r\n           ,[LOCATION_GROUP_HOME_LEAVE]\r\n           ,[CARE_EPISODE_NEONATAL_CRITICAL_CARE_PERIOD_CT]\r\n           ,[CARE_EPISODE_PAEDIATRIC_CRITICAL_CARE_PERIOD_CT]\r\n           ,[ADULT_CRITICAL_CARE_ACTIVITY_CHARACTERISTICS]\r\n           ,[GENERAL_MEDICAL_PRACTITIONER_SPECIFIED]\r\n           ,[GENERAL_MEDICAL_PRACTICE_PATIENT_REGISTRATION]\r\n           ,[REFERRER_CODE]\r\n           ,[ORGANISATION_IDENTIFIER_REFERRING_ORGANISATION]\r\n           ,[DIRECT_ACCESS_REFERRAL_INDICATOR]\r\n           ,[DURATION_OF_ELECTIVE_WAIT]\r\n           ,[INTENDED_MANAGEMENT_CODE]\r\n           ,[DECIDED_TO_ADMIT_DATE]\r\n           ,[EARLIEST_REASONABLE_OFFER_DATE_TIME]\r\n           ,[EARLIEST_CLINICALLY_APPROPRIATE_DATE]\r\n           ,[LATEST_CLINICALLY_APPROPRIATE_DATE])\r\n\r\nSELECT DISTINCT\na.RECORD_ID ,\n\ta.RECORD_ID as CONSULTANT_EPISODE_HOSPITAL_PROVIDER_SPELL_RECORD_ID\n\t,p.RECORD_ID as PATIENT_RECORD_ID\n\t,a.SOURCE_ID CONSULTANT_EPISODE_HOSPITAL_PROVIDER_SPELL_SOURCE_ID\n\t--,a.HOSPITAL_PROVIDER_SPELL_NUMBER\n\n--Header details\n\n--TRANS AND BULK required?\n      ,'01' as LINE_ID_01\n      ,'NHS6-3' as CDS_VERSION\n      --,ISNULL(cast('130' AS VARCHAR(50)), '')\n\t  ,'130' as CDS_TYPE\n      ,ISNULL(cast('@P' AS VARCHAR(50)), '') CDS_PROTOCOL_ID\n      ,ISNULL(cast('B' + isnull(LEFT(h.ORGANISATION_CODE_OF_PROVIDER,3), '')+'00' + isnull(a.CDS_BATCH_CONTENT_ID, '') AS VARCHAR(50)), '') as CDS_UNIQUE_ID\n\t  --,ISNULL(cast('B' + isnull(h.ORGANISATION_CODE_OF_PROVIDER, '')+ isnull(a.CDS_BATCH_CONTENT_ID, '') AS VARCHAR(50)), '') as CDS_UNIQUE_ID\n      ,ISNULL(cast('010' AS VARCHAR(50)), '') as CDS_BULK_REPLACEMENT_GROUP\n      ,ISNULL(cast('@UT' AS VARCHAR(50)), '') as CDS_UPDATE_TYPE\n      , CONVERT(VARCHAR(10), GETDATE(),20) CDS_EXTRACT_DATE\n      ,CONVERT(VARCHAR(10), GETDATE(),24) as CDS_EXTRACT_TIME\n      ,ISNULL(CONVERT(VARCHAR(10), a.EPISODE_END_DATE_TIME,20), '') CDS_APPLICABLE_DATE\n      ,CONVERT(VARCHAR(10), EPISODE_END_DATE_TIME,24) CDS_APPLICABLE_TIME\n      ,ISNULL(cast('@PS' AS VARCHAR(50)), '') CDS_REPORT_PERIOD_START_DATE\n      ,ISNULL(cast('@PE' AS VARCHAR(50)), '') CDS_REPORT_PERIOD_END_DATE\n      ,ISNULL(CONVERT(VARCHAR(10), EPISODE_END_DATE_TIME,20), '') CDS_ACTIVITY_DATE\n      ,ISNULL(cast('' AS VARCHAR(50)), '') CDS_TEST_INDICATOR\n \n      ,@CDS_SENDER_IDENTITY as ORGANISATION_IDENTIFIER_CDS_SENDER  -- CDS_SENDER_IDENTITY\n\t  ,CAST(NULL as varchar(100)) AS ORGANISATION_IDENTIFIER_CDS_RECIPIENT --NEW\n      ,a.RECORD_ID as RECORD_CONNECTION_IDENTIFIER_01\n\n\t  --Updated to 01 by Ammy 25/7/2015\n\t  ,'01' NAME_FORMAT_CODE \n\t,a.CDS_PRIMARY_RECIPIENT\n\t,a.CDS_COPY_RECIPIENT_01\n\t,a.CDS_COPY_RECIPIENT_02\n\t,a.CDS_COPY_RECIPIENT_03\n\t,a.CDS_COPY_RECIPIENT_04\n\t,a.CDS_COPY_RECIPIENT_05\n\r\n\r\n--PATHWAY\n     , CAST('' AS VARCHAR(50)) Unique_Booking_ReferenceNumber_Converted\n      ,CAST(ISNULL(right(path.PATIENT_PATHWAY_IDENTIFIER,12),'') AS VARCHAR(50)) as Patient_Pathway_Identifier\n\t  , CASE WHEN NULLIF(path.PATIENT_PATHWAY_IDENTIFIER,'') is not null then ISNULL(path.ORGANISATION_PATIENT_PATHWAY_IDENTIFIER_ISSUER,h.ORGANISATION_CODE_OF_PROVIDER) ELSE '' END as Organisation_Identifier_Patient_Pathway_Identifier_Issuer\n\n--REFERRAL TO TREATMENT\n\t  , CASE WHEN NULLIF(path.PATIENT_PATHWAY_IDENTIFIER,'') is not null then CAST(h.RTT_PERIOD_STATUS_CODE AS VARCHAR(50)) ELSE '' END as REFERRAL_TO_TREATMENT_PERIOD_STATUS\n\t, CASE WHEN NULLIF(path.PATIENT_PATHWAY_IDENTIFIER,'') is not null  THEN CAST(h.PATHWAY_TYPE_CODE AS VARCHAR(50)) ELSE '' END as   WAITING_TIME_MEASUREMENT_TYPE_COMMISSIONING_DATASET\n      ,CAST(path.CURRENT_REFERRAL_TO_TREATMENT_PERIOD_START_DATE AS VARCHAR(50)) as REFERRAL_TO_TREATMENT_PERIOD_START_DATE\n      ,CAST(path.CURRENT_REFERRAL_TO_TREATMENT_PERIOD_STOP_DATE AS VARCHAR(50)) as REFERRAL_TO_TREATMENT_PERIOD_END_DATE\r\n\r\n--PATIENT IDENTITIY\n/*\nWITHELD STRUCTURE\nNHS_NUMBER_STATUS_INDICATOR_CODE\nORGANISATION_IDETIFIER_RESIDENCE_RESPONSIBILITY\nWITHHELD_IDENTITY_REASON\n\nVERIFIED IDENTITY STRUCTURE\n\n[LOCAL_PATIENT_IDENTIFIER_EXTENDED]\n[ORGANISATION_IDENTIFIER_LOCAL_PATIENT_IDENTIFIER]\n[NHS_NUMBER]\nNHS_NUMBER_STATUS_INDICATOR_CODE\nPOSTCODE_OF_USUAL_ADDRESS\nORGANISATION_IDENTIFIER_RESIDENCE_RESPONSIBILITY\nPERSON_BIRTH_DATE\n\nUNVERIFIED IDENTITY STRUCTURE\n\n[LOCAL_PATIENT_IDENTIFIER_EXTENDED]\n[ORGANISATION_IDENTIFIER_LOCAL_PATIENT_IDENTIFIER]\n[NHS_NUMBER]\nNHS_NUMBER_STATUS_INDICATOR_CODE\n[PERSON_TITLE]\n[PERSON_GIVEN_NAME]\n[PERSON_FAMILY_NAME]\nPATIENT_NAME_SUFFIX\nPATIENT_INITIALS\nPOSTCODE_OF_USUAL_ADDRESS\nORGANISATION_IDENTIFIER_RESIDENCE_RESPONSIBILITY\nPERSON_BIRTH_DATE\n\n*/\n\t,p.[LOCAL_PATIENT_IDENTIFIER] as LOCAL_PATIENT_IDENTIFIER_EXTENDED\n\t,CAST(left(isnull(h.ORGANISATION_CODE_OF_PROVIDER,@ORGANISATION_CODE_CODE_OF_PROVIDER_DEFAULT),3) AS VARCHAR(50))  as [ORGANISATION_IDENTIFIER_LOCAL_PATIENT_IDENTIFIER] \n\t,p.[NHS_NUMBER]\n\t,CAST(dbo.f_Leading_Zeros(isnull(p.NHS_NUMBER_STATUS_INDICATOR_CODE, '3'), 2) AS VARCHAR(50)) as NHS_NUMBER_STATUS_INDICATOR_CODE\n\t,CAST(p.[PERSON_GIVEN_NAME] AS VARCHAR(50)) as [PERSON_GIVEN_NAME]\n\t,CAST(p.[PERSON_TITLE] AS VARCHAR(50)) as [PERSON_TITLE]\n\t\t,CAST(p.PERSON_FULL_NAME AS VARCHAR(50)) as PERSON_FULL_NAME\n\t,CAST(p.[PERSON_FAMILY_NAME] AS VARCHAR(50)) [PERSON_FAMILY_NAME]\n\t,CAST('' AS VARCHAR(50)) as PATIENT_NAME_SUFFIX\r\n\t,CAST('' AS VARCHAR(50)) as PATIENT_INITIALS\n\t,cast(isnull(pa.[ADDRESS_LINE_1], '') \n\t\t+ Case When NullIf(pa.[ADDRESS_LINE_2],'') Is Null Then '' Else ', ' End\n\t\t+ isnull(pa.[ADDRESS_LINE_2], '') \n\t\t+ Case When NullIf(pa.[ADDRESS_LINE_3],'') Is Null Then '' Else ', ' End\n\t\t+ isnull(pa.[ADDRESS_LINE_3], '') \n\t\t+ Case When NullIf(pa.[ADDRESS_LINE_4],'') Is Null Then '' Else ', ' End\n\t\t+ isnull(pa.[ADDRESS_LINE_4], '')  \tAS VARCHAR(175)) as UNSTRUCTURED_ADDRESS\n\t,CAST(LEFT(ISNULL(pa.[ADDRESS_LINE_1],''),35) AS VARCHAR(50)) as [ADDRESS_LINE_1]\n\t,CAST(LEFT(ISNULL(pa.[ADDRESS_LINE_2],''),35) AS VARCHAR(50)) as [ADDRESS_LINE_2]\n\t,CAST(LEFT(pa.[ADDRESS_LINE_3],35) AS VARCHAR(50)) as [ADDRESS_LINE_3]\n\t,CAST(LEFT(pa.[ADDRESS_LINE_4],35) AS VARCHAR(50)) as [ADDRESS_LINE_4]\n\t,CAST(LEFT(pa.[ADDRESS_LINE_5],35)  AS VARCHAR(50)) as [ADDRESS_LINE_5]\n\t,CAST(a.[POSTCODE_AT_ACTIVITY_DATE] AS VARCHAR(50)) as POSTCODE_OF_USUAL_ADDRESS\n\t,CAST(isnull(a.ORGANISATION_CODE_RESIDENCE_RESPONSIBILITY, '') AS VARCHAR(50)) as ORGANISATION_IDENTIFIER_RESIDENCE_RESPONSIBILITY\n\t,CAST(CONVERT(VARCHAR(10), p.[PERSON_BIRTH_DATE],20) AS VARCHAR(20)) PERSON_BIRTH_DATE\n\t--,a.RECORD_ID\n\t,a.MODIFIED_DATE_TIME\n\t,a.ADDED_DATE_TIME\n    ,CAST(a.WITHHELD_IDENTITY_FLAG AS VARCHAR(50))  as WITHHELD_FLAG   --REQUIREDa.WITHHELD_FLAG\n    ,a.WITHHELD_IDENTITY_REASON_CODE WITHHELD_IDENTITY_REASON\n\t,CAST('02' AS VARCHAR(50)) as ADDRESS_FORMAT_CODE\n\n--PATIENT CHARACTERISTICS\n\t ,CAST(ISNULL(p.PERSON_GENDER_CODE, 'X') AS VARCHAR(50)) as PERSON_STATED_GENDER_CODE\n     ,CAST(p.CARER_SUPPORT_INDICATOR_CODE AS VARCHAR(50)) AS CARER_SUPPORT_INDICATOR\n     ,CAST(ISNULL(p.ETHNIC_CATEGORY_CODE,'99') AS VARCHAR(50))  AS ETHNIC_CATEGORY\n\t ,CAST(p.ETHNIC_CATEGORY_2021_CODE AS VARCHAR(50)) AS  ETHNIC_CATEGORY_2021\n     ,CAST(isnull(p.PERSON_MARITAL_STATUS_CODE, '9') AS VARCHAR(50)) as PERSON_MARITAL_STATUS\n\n\t ,CAST('98' AS VARCHAR(50)) as MENTAL_HEALTH_ACT_LEGAL_STATUS_CLASSIFICATION_CODE_ON_ADMISSION\n\n--PATIENT CHARACTERISTICS - SOCIAL AND PERSONAL CIRCUMSTANCES GROUP\n\t  ,CAST('' as varchar(20)) as SOCIAL_AND_PERSONAL_CIRCUMSTANCE_SNOMED_CT \r\n\r\n--HOSPITAL PROVIDER SPELL - ADMISSION CHARACTERISTICS\r\n\t,CAST(h.HOSPITAL_PROVIDER_SPELL_NUMBER AS VARCHAR(50)) as HOSPITAL_PROVIDER_SPELL_IDENTIFIER\n\t,CAST(isnull(h.ADMINISTRATIVE_CATEGORY_CODE_ON_ADMISSION, '') AS VARCHAR(50)) as ADMINISTRATIVE_CATEGORY_CODE_ON_ADMISSION\n\t,CAST(isnull(h.PATIENT_CLASSIFICATION_CODE, '') AS VARCHAR(50)) as PATIENT_CLASSIFICATION\n\t,CAST(isnull(h.ADMISSION_METHOD_CODE_HOSPITAL_PROVIDER_SPELL, '') AS VARCHAR(50)) as METHOD_OF_ADMISSION_HOSPITAL_PROVIDER_SPELL\n\t--,CAST(isnull(h.SOURCE_OF_ADMISSION_HOSPITAL_PROVIDER_SPELL_CODE, '') AS VARCHAR(50)) as ADMISSION_SOURCE_HOSPITAL_PROVIDER_SPELL -- REPLACED WITH SOURCE_OF_ADMISSION_CODE_HOSPITAL_PROVIDER_SPELL @ 1:55 04/10/23 (KE - STGH).\n\t,CAST(isnull(h.SOURCE_OF_ADMISSION_CODE_HOSPITAL_PROVIDER_SPELL, '99') AS VARCHAR(50)) as ADMISSION_SOURCE_HOSPITAL_PROVIDER_SPELL\n\t,isnull(CONVERT(VARCHAR(10),h.START_DATE_TIME_HOSPITAL_PROVIDER_SPELL,20), '') as START_DATE_HOSPITAL_PROVIDER_SPELL\n\t,CONVERT(VARCHAR(10), START_DATE_TIME_HOSPITAL_PROVIDER_SPELL,24) START_TIME_HOSPITAL_PROVIDER_SPELL\n\t,CAST(dbo.f_Leading_Zeros(h.AGE_AT_ADMISSION_DATE, 3) AS VARCHAR(50)) as AGE_ON_ADMISSION\n\n\t,CAST('' as varchar(20)) as AMBULANCE_CALL_IDENTIFIER\n\t,CAST('' as varchar(20)) as ORGANISATION_IDENTIFIER_CONVEYING_AMBULANCE_TRUST\r\n\t,CAST('' as varchar(20)) as CARE_CONTACT_IDENTIFIER_AMBULANCE_SERVICE\r\n\n--HOSPITAL PROVIDER SPELL - DISCHARGE CHARACTERISTICS\n      ,CAST(isnull(h.DISCHARGE_DESTINATION_CODE_HOSPITAL_PROVIDER_SPELL, '') AS VARCHAR(50)) as DESTINATION_OF_DISCHARGE_HOSPITAL_PROVIDER_SPELL\n      --,CAST(isnull(h.DISCHARGE_METHOD_CODE_HOSPITAL_PROVIDER_SPELL_CDS, '') AS VARCHAR(50))\n\t  ,Left(CAST(isnull(h.DISCHARGE_METHOD_CODE_HOSPITAL_PROVIDER_SPELL, '') AS VARCHAR(50)),1) as METHOD_OF_DISCHARGE_HOSPITAL_PROVIDER_SPELL\n      ,isnull(CONVERT(VARCHAR(10), h.DISCHARGE_READY_DATE_TIME,20), '') as  DISCHARGE_READY_DATE_TIME\n      ,isnull(CONVERT(VARCHAR(10), h.DISCHARGE_DATE_TIME_HOSPITAL_PROVIDER_SPELL,20), '') as DISCHARGE_DATE_HOSPITAL_PROVIDER_SPELL\n      ,CONVERT(VARCHAR(10), DISCHARGE_DATE_TIME_HOSPITAL_PROVIDER_SPELL,24)  as DISCHARGE_TIME_HOSPITAL_PROVIDER_SPELL\n      ,CAST(ISNULL(CASE a.DISCHARGE_TO_HOME_INDICATOR_PROVIDER_SPELL WHEN '1' THEN 'Y' WHEN '0' THEN 'N' END, '9') AS VARCHAR(50)) DISCHARGE_TO_NHS_AT_HOME_SERVICE_INDICATOR\r\n\r\n--CARE EPISODE - ACTIVITY CHARACTERISTICS\r\n\t   ,CAST(dbo.f_Leading_Zeros(a.EPISODE_NUMBER, 2) AS VARCHAR(50)) as EPISODE_NUMBER\n      ,cast(isnull(a.LAST_EPISODE_IN_SPELL_INDICATOR_CODE,2) as varchar(3)) LAST_EPISODE_IN_SPELL_INDICATOR_CODE\n      ,CAST(isnull(a.ADMINISTRATIVE_CATEGORY_CODE, '') AS VARCHAR(50)) as ADMINISTRATIVE_CATEGORY\n     -- ,CAST(isnull(a.OPERATION_STATUS_CODE, '') AS VARCHAR(50)) as OPERATION_STATUS_CODE\n      ,'8' as NEONATAL_LEVEL_OF_CARE_CODE--CAST(isnull(a.NEONATAL_LEVEL_OF_CARE, '') AS VARCHAR(50)) as NEONATAL_LEVEL_OF_CARE\n      ,CAST(isnull(h.FIRST_REGULAR_DAY_OR_NIGHT_ADMISSION, '') AS VARCHAR(50)) as FIRST_REGULAR_DAY_OR_NIGHT_ADMISSION_CODE --,CAST(isnull(a.FIRST_WARD_STAY_IDENTIFIER, '') AS VARCHAR(50)) \n      ,CAST(ISNULL(a.PSYCHIATRIC_PATIENT_STATUS_CODE,'8') AS VARCHAR(50)) as PSYCHIATRIC_PATIENT_STATUS_CODE\n      --,CAST('98' AS VARCHAR(50))\n      ,isnull(CONVERT(VARCHAR(10), a.EPISODE_START_DATE_TIME,20), '') as START_DATE_EPISODE\n\t  ,isnull(CONVERT(VARCHAR(10), EPISODE_START_DATE_TIME,24),'')  as START_TIME_EPISODE\n      ,isnull(CONVERT(VARCHAR(10), a.EPISODE_END_DATE_TIME,20), '') as END_DATE_EPISODE\n\t  ,isnull(CONVERT(VARCHAR(10), EPISODE_END_DATE_TIME,24),'')    as END_TIME_EPISODE\n      ,CAST(dbo.f_Leading_Zeros(a.AGE_AT_START_DATE_EPISODE, 3) AS VARCHAR(50))  as AGE_AT_CDS_ACTIVITY_DATE  --Check activity date definition\n      \n      ,CAST('' as varchar(20)) as REHABILITATION_ASSESSMENT_TEAM_TYPE\n\t\t--,''--OVERSEAS_VISITOR_STATUS\n\n--CARE EPISODE - LENGTH OF STAY ADJUSTMENT\n\t\t,CAST('' AS VARCHAR(50)) as LENGTH_OF_STAY_ADJUSTMENT_REHABILITATION\r\n\t\t,CAST('' AS VARCHAR(50)) as LENGTH_OF_STAY_ADJUSTMENT_SPECIALIST_PALLIATIVE_CARE\r\n--CARE EPISODE - OVERSEAS VISITOR CHARGING CATEGORY\r\n\t\t,CAST(isnull(a.OVERSEAS_VISITOR_CHARGING_CATEGORY_CODE,'' ) as varchar(20))  as OVERSEAS_VISITOR_CHARGING_CATEGORY\r\n\t\t,isnull(CONVERT(VARCHAR(10), a.EPISODE_START_DATE_TIME,20), '') as OVERSEAS_VISITOR_CHARGING_CATEGORY_APPLICABLE_FROM_DATE\r\n\t\t,isnull(CONVERT(VARCHAR(10), a.EPISODE_END_DATE_TIME,20), '') as OVERSEAS_VISITOR_CHARGING_CATEGORY_APPLICABLE_END_DATE\n\n--CARE EPISODE - SERVICE AGREEMENT DETAILS\n\t\t--,CAST(ISNULL('', '999999') AS VARCHAR(50)) --CHECK ID feild available\n\t\t,left(CAST(ISNULL(a.ORGANISATION_CODE_OF_PROVIDER,@ORGANISATION_CODE_CODE_OF_PROVIDER_DEFAULT) AS VARCHAR(50)),3)  as  ORGANISATION_IDENTIFIER_CODE_OF_PROVIDER  \n\t\t,CAST(ISNULL(a.ORGANISATION_CODE_OF_COMMISSIONER, @ORGANISATION_CODE_CODE_OF_COMMISSIONER_DEFAULT) AS VARCHAR(50)) as ORGANISATION_IDENTIFIER_CODE_OF_COMMISSIONER\n\t\t,CAST(a.EPISODE_START_DATE AS VARCHAR(50))  as START_DATE_COMMISSIONER_ASSIGNMENT_PERIOD\r\n\t\t,CAST(a.EPISODE_END_DATE AS VARCHAR(50))  as END_DATE_COMMISSIONER_ASSIGNMENT_PERIOD\r\n\t\t,CAST(a.SERVICE_LINE AS VARCHAR(50))  as NHS_SERVICE_AGREEMENT_IDENTIFIER\n      ,CAST(a.CONT_NHS_SRV_AGR_LN_NO AS VARCHAR(50)) as NHS_SERVICE_AGREEMENT_LINE_IDENTIFIER  --CHECK If field availableNHS_SERVICE_AGREEMENT_LINE_NUMBER\n      ,CAST(CONT_PROV_REF_NO AS VARCHAR(50)) as PROVIDER_REFERENCE_IDENTIFIER  --CHECK If field available PROVIDER_REFERENCE_NUMBER\n      ,CAST(CONT_COMM_REF_NO AS VARCHAR(50)) as COMMISSIONER_REFERENCE_IDENTIFIER --CHECK If field available \n\t    ,CAST('' AS VARCHAR(50)) as SERVICE_CODE\n\t  \r\n--CARE EPISODE - PERSON GROUP CARE PROFESSIONAL\r\n,CAST('' AS VARCHAR(50)) as  RESPONSIBLE_CARE_PROFESSIONAL_CT\r\n\r\n--CLINICAL DIAGNOSES GROUP ICD -- PRIMARY DIAGNOSIS ADJUSTED BY KE(STG) TO CATER TO SHORTER DIAG CODES REQUIRING A SUFFIX 'X'\n      ,CAST('02' as varchar(2)) as DIAGNOSIS_SCHEME_IN_USE_COMMISSIONING_DATASET\n     -- ,CAST(REPLACE(pd.DIAGNOSIS_01,'.','') AS VARCHAR(50)) as PRIMARY_DIAGNOSIS_ICD \r\n\t ,CAST(REPLACE(CASE WHEN LEN(pd.DIAGNOSIS_01) = 3 THEN pd.DIAGNOSIS_01 + 'X' ELSE pd.DIAGNOSIS_01 END,'.','') AS VARCHAR(50)) as PRIMARY_DIAGNOSIS_ICD\r\n\t ,CAST('9' AS VARCHAR(50)) AS PRESENT_ON_ADMISSION_INDICATOR\r\n\r\n--CLINICAL DIAGNOSIS SECONDARY ICD GROUP\r\n\t,cast('' as varchar(max) ) as  SECONDARY_DIAGNOSIS_CT\r\n\r\n--CARE EPISODE - CLINICAL DIAGNOSIS GROUP SNOMED \r\n\t  ,CAST('' as varchar(max)) as CARE_EPISODE_CLINICAL_DIAGNOSIS_GROUP_SNOMED_CT\r\n\r\n--CARE EPISODE - COMORBIDITY (SNOMED CT)\r\n\t ,CAST('' as varchar(max)) as CARE_EPISODE_COMORBIDITY_GROUP_SNOMED_CT\r\n\r\n--CARE EPISODE - EMED3 FIT NOTE\r\n\t,CAST('' AS VARCHAR(50))  AS EMED3_FIT_NOTE_ASSESSMENT_DATE\r\n\t,CAST('' AS VARCHAR(50))   AS EMED3_FIT_NOTE_CONDITION_SNOMED_CT_EXPRESSION\r\n\t,CAST('' AS VARCHAR(50)) AS EMED3_FIT_NOTE_DIAGNOSIS_ICD\r\n\t,CAST('' AS VARCHAR(50)) AS EMED3_FIT_NOTE_START_DATE\r\n\t,CAST('' AS VARCHAR(50)) AS EMED3_FIT_NOTE_END_DATE\r\n\t,CAST('' AS VARCHAR(50))  AS EMED3_FIT_NOTE_DURATION\r\n\t,CAST('' AS VARCHAR(50))  AS EMED3_FIT_NOTE_RECORDED_DATE\r\n\t,CAST('' AS VARCHAR(50)) AS  EMED3_FIT_NOTE_FOLLOW_UP_ASSESSMENT_REQUIRED_INDICATOR\r\n\t,CAST('' AS VARCHAR(50)) AS  EMED3_FIT_NOTE_ISSUER\r\n\r\n--CARE EPISODE - PROCEDURE GROUP (OPCS)\r\n\t,CAST('02' as varchar(2)) AS  PROCEDURE_SCHEME_IN_USE_COMMISSIONING_DATA_SET\n\t,CAST(replace(pp.[PROCEDURE_CODE_01],'.','') AS VARCHAR(50)) as PRIMARY_PROCEDURE\n\t,isnull(CONVERT(VARCHAR(10), pp.PROCEDURE_DATE_01,20), '')    AS PROCEDURE_DATE\r\n\t,CAST('' AS VARCHAR(50)) AS PROFESSIONAL_REGISTRATION_ISSUER_CODE\r\n\t,ISNULL(CAST(ISNULL(CARE_PROFESSIONAL_IDENTIFIER_CODE,CONSULTANT_CODE) AS VARCHAR(50)),'') AS PROFESSIONAL_REGISTRATION_ENTRY_IDENTIFIER_MAIN_OPERATING_CARE_PROFESSIONAL\r\n\t,CAST('' AS VARCHAR(50)) AS PROFESSIONAL_REGISTRATION_ISSUER_CODE_ANAESTHETIST\r\n\t,CAST('' AS VARCHAR(50)) AS PROFESSIONAL_REGISTRATION_ENTRY_IDENTIFIER_RESPONSIBLE_ANAESTHETIST\r\n\r\n--SECONDARY PROCEDURES (OPCS)\n\t,CAST('' as varchar(max)) as SECONDARY_PROCEDURES_CT\n\n--CARE EPISODE - PROCEDURE GROUP (SNOMED CT)\n\t,CAST('' as varchar(max)) as CARE_EPISODE_PROCEDURE_GROUP_SNOMED_CT\n\n--CARE EPISODE - OBSERVATION GROUP (SNOMED CT)\n\t,CAST('' as varchar(max)) as CARE_EPISODE_OBSERVATION_GROUP_SNOMED_CT\n\n--CARE EPISODE - FINDING GROUP (SNOMED CT)\n\t,CAST('' as varchar(max)) as CARE_EPISODE_FINDING_GROUP_SNOMED_CT\n\n--CARE EPISODE - ASSESSMENT TOOL GROUP (SNOMED CT)\n\t,CAST('' as varchar(max)) as CARE_EPISODE_ASSESSMENT_TOOL_GROUP_SNOMED_CT\n\n --LOCATION GROUP (AT START OF CARE EPISODE)\n       ,CAST(isnull(ws.SITE_CODE_OF_TREATMENT, lws.SITE_CODE_OF_TREATMENT) AS VARCHAR(50)) as ORGANISATION_SITE_IDENTIFIER_OF_TREATMENT\n      ,CAST(isnull(NULL, '') AS VARCHAR(50)) as ACTIVITY_LOCATION_TYPE_CODE\n      ,CAST(isnull(ws.INTENDED_CLINICAL_CARE_INTENSITY_CODE, '') AS VARCHAR(50)) as WARD_INTENDED_CLINICAL_CARE_INTENSITY\n      ,CAST(isnull(ws.INTENDED_AGE_GROUP_CODE, '') AS VARCHAR(50)) as WARD_INTENDED_AGE_GROUP  --ws.INTENDED_AGE_GROUP\n      ,CAST(isnull(ws.SEX_OF_PATIENTS_CODE, '') AS VARCHAR(50)) as WARD_INTENDED_SEX_OF_PATIENTS\n      ,CAST(isnull(ws.WARD_DAY_PERIOD_AVAILABILITY_CODE, '0') AS VARCHAR(50)) as WARD_INTENDED_DAY_PERIOD_AVAILABILITY\n      ,CAST(isnull(ws.WARD_NIGHT_PERIOD_AVAILABILITY_CODE, '0') AS VARCHAR(50)) as WARD_INTENDED_NIGHT_PERIOD_AVAILABILITY\n    --  ,isnull(CONVERT(VARCHAR(8), ws.WARD_STAY_END_DATE_TIME,112), '') as WARD_STAY_END_DATE\n     -- ,ISNULL(CONVERT(varchar(6), REPLACE(convert(varchar(8), ws.WARD_STAY_END_DATE_TIME, 114),':','') ),'') as WARD_STAY_END_TIME\n     -- ,isnull(CONVERT(VARCHAR(8), ws.WARD_STAY_START_DATE_TIME,112), '') as WARD_STAY_START_DATE\n      --,ISNULL(CONVERT(varchar(6), REPLACE(convert(varchar(8), ws.WARD_STAY_START_DATE_TIME, 114),':','') ),'') as WARD_STAY_START_TIME\n      ,ISNULL('','0') as WARD_SECURITY_LEVEL  -- ws.WARD_SECURITY_LEVEL\n      --,CAST(ws.WARD_LOCAL_ID as varchar(max)) as WARD_CODE\n\t  --,CAST(LEFT(dbo.REMOVESPECIALCHARS(h.ADMITTING_WARD_CODE),12) as varchar(12)) as WARD_CODE\n\t  ,ISNULL(CAST(ws.WARD_LOCAL_ID as varchar(12)), '') as WARD_CODE\n     -- ,dbo.f_Leading_Zeros( WARD_STAY_ORDER,3)\n     -- ,'04'\n\n\t \n\n--LOCATION GROUP (AT WARD STAY)\n\t,CAST('' as varchar(max)) as LOCATION_GROUP_AT_WARD_STAY_CT\n\n--LOCATION GROUP (AT END OF CARE EPISODE)\n\t,CAST(isnull(lws.SITE_CODE_OF_TREATMENT,isnull(a.SITE_CODE_OF_TREATMENT,'')) AS VARCHAR(50)) as ORGANISATION_SITE_IDENTIFIER_OF_TREATMENT_LAST_EPI\n      ,CAST(isnull(NULL, '') AS VARCHAR(50)) as ACTIVITY_LOCATION_TYPE_CODE_LAST_EPI\n      ,CAST(isnull(LWS.INTENDED_CLINICAL_CARE_INTENSITY_CODE, '') AS VARCHAR(50)) as WARD_INTENDED_CLINICAL_CARE_INTENSITY_LAST_EPI\n      ,CAST(isnull(lws.INTENDED_AGE_GROUP_CODE, '') AS VARCHAR(50)) as WARD_INTENDED_AGE_GROUP_LAST_EPI --LWS.INTENDED_AGE_GROUP\n      ,CAST(isnull(LWS.SEX_OF_PATIENTS_CODE, '') AS VARCHAR(50)) as WARD_INTENDED_SEX_OF_PATIENTS_LAST_EPI\n      ,CAST(isnull(LWS.WARD_DAY_PERIOD_AVAILABILITY_CODE, '0') AS VARCHAR(50)) as WARD_INTENDED_DAY_PERIOD_AVAILABILITY_LAST_EPI\n      ,CAST(isnull(LWS.WARD_NIGHT_PERIOD_AVAILABILITY_CODE, '0') AS VARCHAR(50)) as WARD_INTENDED_NIGHT_PERIOD_AVAILABILITY_LAST_EPI\n      --,isnull(CONVERT(VARCHAR(8), LWS.WARD_STAY_END_DATE_TIME,112), '') as WARD_STAY_END_DATE_LAST_EPI\n     -- ,ISNULL(CONVERT(varchar(6), REPLACE(convert(varchar(8), LWS.WARD_STAY_END_DATE_TIME, 114),':','') ),'') WARD_STAY_END_TIME_LAST_EPI\n     -- ,isnull(CONVERT(VARCHAR(8), ws.WARD_STAY_START_DATE_TIME,112), '') as WARD_STAY_START_DATE_LAST_EPI\n     -- ,ISNULL(CONVERT(varchar(6), REPLACE(convert(varchar(8), LWS.WARD_STAY_START_DATE_TIME, 114),':','') ),'') as WARD_STAY_START_TIME_LAST_EPI\n      ,ISNULL('','0') as WARD_SECURITY_LEVEL_LAST_EPI --LWS.WARD_SECURITY_LEVEL\n      --,CAST(ws.WARD_LOCAL_ID as varchar(max)) as WARD_CODE_LAST_EPI\n\t  -- ,CAST(LEFT(dbo.REMOVESPECIALCHARS(h.DISCHARGING_WARD_CODE),12) as varchar(12)) as WARD_CODE_LAST_EPI\n\t  ,ISNULL(CAST(LWS.WARD_LOCAL_ID as varchar(12)), '') as WARD_CODE_LAST_EPI\n-- ,dbo.f_Leading_Zeros( WARD_STAY_ORDER,3)\n-- ,'04'\n--LOCATION GROUP - HOME LEAVE\n\t,CAST('' as varchar(max)) as LOCATION_GROUP_HOME_LEAVE\n--CARE EPISODE - NEONATAL CRITICAL CARE PERIOD\n\r\n----ADmission Charachteristicd\r\n --CRITICAL CARE LOCAL IDENTIFIER\r\n-- CRITICAL CARE START DATE\r\n--CRITICAL CARE END DATE\r\n--CRITICAL CARE UNIT FUNCTION\r\n--GESTATION LENGTH (AT DELIVERY)\r\n\r\n\t,CAST('' as varchar(max)) as CARE_EPISODE_NEONATAL_CRITICAL_CARE_PERIOD_CT\r\n----Discharge Charachteristics\r\n--CRITICAL CARE DISCHARGE DATE\r\n--CRITICAL CARE DISCHARGE TIME\r\n\r\n\n--CARE EPISODE - PAEDIATRIC CRITICAL CARE PERIOD\n--CRITICAL CARE LOCAL IDENTIFIER\r\n--CRITICAL CARE START DATE\r\n--CRITICAL CARE START TIME\r\n--CRITICAL CARE UNIT FUNCTION\r\n\n\t,CAST('' as varchar(max)) as CARE_EPISODE_PAEDIATRIC_CRITICAL_CARE_PERIOD_CT\r\n\r\n--CRITICAL CARE DISCHARGE DATE\r\n--CRITICAL CARE DISCHARGE TIME\r\n\r\n\n--ADULT CRITICAL CARE - ADMISSION CHARACTERISTICS\n\n--CRITICAL CARE LOCAL IDENTIFIER\r\n--CRITICAL CARE START DATE\r\n--CRITICAL CARE START TIME\r\n--CRITICAL CARE UNIT FUNCTION\r\n--CRITICAL CARE UNIT BED CONFIGURATION\r\n--CRITICAL CARE ADMISSION SOURCE\r\n--CRITICAL CARE SOURCE LOCATION\r\n--CRITICAL CARE ADMISSION TYPE\r\n\r\n--ADULT CRITICAL CARE ACTIVCITY CHARACHTERISTICS\r\n--ADVANCED RESPIRATORY SUPPORT DAYS\r\n--BASIC RESPIRATORY SUPPORT DAYS\r\n--ADVANCED CARDIOVASCULAR SUPPORT DAYS\r\n--BASIC CARDIOVASCULAR SUPPORT DAYS\r\n--RENAL SUPPORT DAYS\r\n--NEUROLOGICAL SUPPORT DAYS\r\n--GASTRO-INTESTINAL SUPPORT DAYS\r\n--DERMATOLOGICAL SUPPORT DAYS\r\n--LIVER SUPPORT DAYS\r\n--ORGAN SUPPORT MAXIMUM\r\n--CRITICAL CARE LEVEL 2 DAYS\r\n--CRITICAL CARE LEVEL 3 DAYS\r\n\r\n\t,CAST('' as varchar(max)) as ADULT_CRITICAL_CARE_ACTIVITY_CHARACTERISTICS\n\n--ADULT CRITICAL CARE - DISCHARGE CHARACTERISTICS\n--CRITICAL CARE DISCHARGE DATE\r\n--CRITICAL CARE DISCHARGE TIME\r\n--CRITICAL CARE DISCHARGE READY DATE\r\n--CRITICAL CARE DISCHARGE READY TIME\r\n--CRITICAL CARE DISCHARGE STATUS\r\n--CRITICAL CARE DISCHARGE DESTINATION\r\n--CRITICAL CARE DISCHARGE LOCATION\r\n\n--GP REGISTRATION\n\t,ISNULL(a.GENERAL_MEDICAL_PRACTITIONER, 'X9999998') as GENERAL_MEDICAL_PRACTITIONER_SPECIFIED\n\t,isnull(a.GENERAL_MEDICAL_PRACTICE_CODE, 'X99998') as GENERAL_MEDICAL_PRACTICE_PATIENT_REGISTRATION\n\n--REFERRER\n\t,CAST(ISNULL('', '') AS VARCHAR(50)) REFERRER_CODE\n\t,CAST(isnull('', '') AS VARCHAR(50)) ORGANISATION_IDENTIFIER_REFERRING_ORGANISATION\n\n--REFERRAL\n\t, CAST('' as varchar(20)) as DIRECT_ACCESS_REFERRAL_INDICATOR\n\n--ELECTIVE ADMISSION LIST ENTRY\n\t,ISNULL(CAST(h.DURATION_OF_ELECTIVE_WAIT AS VARCHAR(4)),'') as DURATION_OF_ELECTIVE_WAIT\n\t,ISNULL(CAST(h.INTENDED_MANAGEMENT_CODE AS VARCHAR(50)),'') as INTENDED_MANAGEMENT_CODE\n\t,ISNULL(CONVERT(VARCHAR(10),h.DECIDED_TO_ADMIT_DATE, 20),'') as DECIDED_TO_ADMIT_DATE\n\t,ISNULL(CONVERT(VARCHAR(10),h.EARLIEST_REASONABLE_OFFER_DATE_TIME, 20),'') as EARLIEST_REASONABLE_OFFER_DATE_TIME\n\t,CAST('' as varchar(20)) as EARLIEST_CLINICALLY_APPROPRIATE_DATE\r\n\t,CAST('' as varchar(20)) as LATEST_CLINICALLY_APPROPRIATE_DATE\r\n\t\r\n--SELEcT count(*)\nFROM INP_CONSULTANT_EPISODE_HOSPITAL_PROVIDER_SPELL a\n\tLEFT JOIN INP_HOSPITAL_PROVIDER_SPELL h ON a.HOSPITAL_PROVIDER_SPELL_RECORD_ID = h.RECORD_ID\n\tinner JOIN INP_PATIENT p ON a.PATIENT_RECORD_ID = p.RECORD_ID\n\tLEFT JOIN INP_PATIENT_ADDRESS pa ON pa.RECORD_ID = a.PATIENT_ADDRESS_RECORD_ID\r\n\tLEFT JOIN INP_CONSULTANT_EPISODE_HOSPITAL_PROVIDER_SPELL_DIAGNOSIS_SR pd on pd.CONSULTANT_EPISODE_HOSPITAL_PROVIDER_SPELL_RECORD_ID = a.RECORD_ID and pd.DIAGNOSIS_SCHEME_IN_USE = 'ICD10'\r\n\tLEFT JOIN  INP_CONSULTANT_EPISODE_HOSPITAL_PROVIDER_SPELL_PROCEDURE_SR pp on pp.CONSULTANT_EPISODE_HOSPITAL_PROVIDER_SPELL_RECORD_ID = a.RECORD_ID and PROCEDURE_SCHEME_IN_USE = 'OPCS4'\r\n\tLEFT JOIN INP_CONSULTANT_EPISODE_HOSPITAL_PROVIDER_SPELL_WARD_STAY WS on ws.CONSULTANT_EPISODE_HOSPITAL_PROVIDER_SPELL_RECORD_ID = a.RECORD_ID AND ws.FIRST_WARD_FLAG = 1\r\n\tLEFT JOIN INP_CONSULTANT_EPISODE_HOSPITAL_PROVIDER_SPELL_WARD_STAY LWS on LWS.CONSULTANT_EPISODE_HOSPITAL_PROVIDER_SPELL_RECORD_ID = a.RECORD_ID AND LWS.LAST_WARD_FLAG = 1\r\n\t--LEFT JOIN INP_PATHWAY path on path.PATIENT_PATHWAY_IDENTIFIER = h.PATIENT_PATHWAY_IDENTIFIER\r\n\tLEFT JOIN (SELECT * ,Row_order = ROW_NUMBER() OVER ( PARTITION BY PATIENT_PATHWAY_IDENTIFIER ORDER BY ADDED_DATE_TIME desc)  FROM INP_PATHWAY) path on path.PATIENT_PATHWAY_IDENTIFIER = h.PATIENT_PATHWAY_IDENTIFIER and path.PATIENT_SOURCE_ID = h.PATIENT_SOURCE_ID and Row_order =1\r\n\r\n\t--508208\r\n\r\nWHERE \r\n\ta.ACTIVITY_DATE_TIME >= '2023-04-01' AND\r\n\t(ws.FIRST_WARD_FLAG = 1 or ws.FIRST_WARD_FLAG is null) and (LWS.LAST_WARD_FLAG = 1 or LWS.LAST_WARD_FLAG is null)\r\n\tand a.ACTIVE_FLAG=1\r\n\t--and CDS_BATCH_CONTENT_ID is not null\r\n\t--and a.ACTIVITY_DATE_TIME < GETDATE()\r\nGO\r\n"}